<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BPEL2UDDI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jUDDI Client side Code</a> &gt; <a href="index.source.html" class="el_package">org.apache.juddi.v3.client.mapping.wsdl</a> &gt; <span class="el_source">BPEL2UDDI.java</span></div><h1>BPEL2UDDI.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001-2011 The Apache Software Foundation.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
package org.apache.juddi.v3.client.mapping.wsdl;

import org.apache.juddi.v3.client.mapping.Common2UDDI;
import java.net.MalformedURLException;
import java.net.URL;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;

import javax.wsdl.Binding;
import javax.wsdl.Definition;
import javax.wsdl.Port;
import javax.wsdl.PortType;
import javax.wsdl.Service;
import javax.wsdl.WSDLException;
import javax.xml.namespace.QName;

import org.apache.commons.configuration.ConfigurationException;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.juddi.api_v3.AccessPointType;
import org.apache.juddi.jaxb.PrintUDDI;
import org.apache.juddi.v3.annotations.AnnotationProcessor;
import org.apache.juddi.v3.client.config.Property;
import org.apache.juddi.v3.client.config.UDDIClerk;
import org.apache.juddi.v3.client.config.UDDIKeyConvention;
import org.apache.juddi.v3.client.mapping.URLLocalizer;
import org.apache.juddi.v3.client.transport.TransportException;
import org.uddi.api_v3.AccessPoint;
import org.uddi.api_v3.BindingTemplate;
import org.uddi.api_v3.BusinessService;
import org.uddi.api_v3.CategoryBag;
import org.uddi.api_v3.FindBinding;
import org.uddi.api_v3.FindTModel;
import org.uddi.api_v3.GetTModelDetail;
import org.uddi.api_v3.InstanceDetails;
import org.uddi.api_v3.KeyedReference;
import org.uddi.api_v3.Name;
import org.uddi.api_v3.OverviewDoc;
import org.uddi.api_v3.OverviewURL;
import org.uddi.api_v3.TModel;
import org.uddi.api_v3.TModelBag;
import org.uddi.api_v3.TModelDetail;
import org.uddi.api_v3.TModelInfo;
import org.uddi.api_v3.TModelInstanceDetails;
import org.uddi.api_v3.TModelInstanceInfo;
import org.uddi.api_v3.TModelList;
import org.w3c.dom.Element;


/**
 * BPEL4WS abstract processes describe the observable behavior of Web services. They 
 * complement abstract WSDL interfaces (port types and operations) and the UDDI model 
 * by defining dependencies between service operations in the context of a message 
 * exchange. The technical note 'uddi-spec-tc-tn-bpel' describes the relationships 
 * between the three models and suggests how BPEL4WS abstract processes can be used 
 * in a UDDI Registry. This class implements the registrations suggestions as put 
 * forward in the technote.
 * 
 * * @author Kurt T Stam &lt;kurt.stam@apache.org&gt;
 *
 */
public class BPEL2UDDI extends AnnotationProcessor {
	
<span class="fc" id="L84">	private Log log = LogFactory.getLog(this.getClass());</span>
	
	private String keyDomainURI;
	private UDDIClerk clerk;
	private String lang;
	private URLLocalizer urlLocalizer;
	private String businessKey;
<span class="fc" id="L91">	private Properties properties = new Properties();</span>

	private WSDL2UDDI wsdl2UDDI;
	
	public BPEL2UDDI(UDDIClerk clerk, URLLocalizer urlLocalizer, Properties properties) throws ConfigurationException {
<span class="fc" id="L96">		super();</span>
		
<span class="fc" id="L98">		this.clerk = clerk;</span>
<span class="fc" id="L99">		this.urlLocalizer = urlLocalizer;</span>
<span class="fc" id="L100">		this.properties = properties;</span>
		
		//Obtaining values from the properties
<span class="fc" id="L103">		this.keyDomainURI = &quot;uddi:&quot; + properties.getProperty(&quot;keyDomain&quot;) + &quot;:&quot;;</span>
<span class="fc" id="L104">		this.businessKey = UDDIKeyConvention.getBusinessKey(properties);</span>
<span class="fc" id="L105">		this.lang = properties.getProperty(Property.LANG,Property.DEFAULT_LANG);</span>
		
<span class="fc" id="L107">		this.wsdl2UDDI = new WSDL2UDDI(clerk, urlLocalizer, properties);</span>
<span class="fc" id="L108">	}</span>
	
	public String getKeyDomainURI() {
<span class="nc" id="L111">		return keyDomainURI;</span>
	}

	public void setKeyDomainURI(String keyDomainURI) {
<span class="nc" id="L115">		this.keyDomainURI = keyDomainURI;</span>
<span class="nc" id="L116">	}</span>
	
	public UDDIClerk getClerk() {
<span class="nc" id="L119">		return clerk;</span>
	}

	public void setClerk(UDDIClerk clerk) {
<span class="nc" id="L123">		this.clerk = clerk;</span>
<span class="nc" id="L124">	}</span>
	
	public String getLang() {
<span class="nc" id="L127">		return lang;</span>
	}

	public void setLang(String lang) {
<span class="nc" id="L131">		this.lang = lang;</span>
<span class="nc" id="L132">	}</span>
	
	public URLLocalizer getUrlLocalizer() {
<span class="nc" id="L135">		return urlLocalizer;</span>
	}

	public void setUrlLocalizer(URLLocalizer urlLocalizer) {
<span class="nc" id="L139">		this.urlLocalizer = urlLocalizer;</span>
<span class="nc" id="L140">	}</span>

	/**
	 * 1. Register PortType tModels
	 * 2. Register WSDL BPEL4WS Process
	 * 3. Register WSDL Port
	 * 4. Register Process Service
	 * 5. Register Binding
	 * 
	 * @param serviceName - QName of the service
	 * @param portName - portName of the service
	 * @param serviceUrl - URL at which the service can be invoked
	 * @param wsdlDefinition - WSDL Definition of the Web Service
         * @return a binding template
	 * @throws WSDLException 
	 * @throws MalformedURLException 
	 * @throws TransportException 
	 * @throws ConfigurationException 
	 * @throws RemoteException 
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public BindingTemplate register(QName serviceName, String portName, URL serviceUrl, Definition wsdlDefinition) 
		throws WSDLException, MalformedURLException, RemoteException, ConfigurationException, TransportException 
	{
<span class="nc" id="L164">		String targetNamespace = wsdlDefinition.getTargetNamespace();</span>
<span class="nc" id="L165">		String genericWSDLURL  = wsdlDefinition.getDocumentBaseURI();   //TODO maybe point to repository version</span>
<span class="nc" id="L166">		String bpelOverviewURL = &quot;http://localhost:8080/bpel-console/&quot;; //TODO maybe point to bpel in console</span>
		
<span class="nc" id="L168">		String serviceKey = UDDIKeyConvention.getServiceKey(properties, serviceName.getLocalPart());</span>
<span class="nc" id="L169">		BusinessService service = lookupService(serviceKey);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (service==null) {</span>
<span class="nc" id="L171">			List&lt;TModel&gt; tModels = new ArrayList&lt;TModel&gt;();</span>
			// Create the PortType tModels
<span class="nc" id="L173">			Map&lt;QName,PortType&gt; portTypes = (Map&lt;QName,PortType&gt;) wsdlDefinition.getAllPortTypes();</span>
<span class="nc" id="L174">			tModels.addAll(createWSDLPortTypeTModels(genericWSDLURL, portTypes));</span>
			// Create the Binding tModels
<span class="nc" id="L176">			Map&lt;QName,Binding&gt; bindings = (Map&lt;QName,Binding&gt;) wsdlDefinition.getAllBindings();</span>
<span class="nc" id="L177">			tModels.addAll(createWSDLBindingTModels(genericWSDLURL, bindings));</span>
			// Create the BPEL4WS tModel
<span class="nc" id="L179">			TModel bpel4WSTModel = createBPEL4WSProcessTModel(serviceName, targetNamespace, portTypes, bpelOverviewURL);</span>
<span class="nc" id="L180">		    tModels.add(bpel4WSTModel);</span>
		    // Register these tModels
<span class="nc bnc" id="L182" title="All 2 branches missed.">		    for (TModel tModel : tModels) {</span>
<span class="nc" id="L183">				clerk.register(tModel);</span>
<span class="nc" id="L184">			}</span>
		    // BPEL Service
<span class="nc" id="L186">		    service = createBusinessService(serviceName, wsdlDefinition);</span>
		    // Register this BPEL Service
<span class="nc" id="L188">		    clerk.register(service);</span>
		}
		//Add the BindingTemplate to this Service
<span class="nc" id="L191">		BindingTemplate binding = createBPELBinding(serviceName, portName, serviceUrl, wsdlDefinition);</span>
		// Register BindingTemplate
<span class="nc" id="L193">		clerk.register(binding);</span>
<span class="nc" id="L194">		return binding;</span>
	}
	
	public String unRegister(QName serviceName, String portName, URL serviceUrl) throws RemoteException, ConfigurationException, TransportException {
		
<span class="nc" id="L199">		String serviceKey = UDDIKeyConvention.getServiceKey(properties, serviceName.getLocalPart());</span>
<span class="nc" id="L200">		BusinessService service = lookupService(serviceKey);</span>
<span class="nc" id="L201">		boolean isRemoveServiceIfNoTemplates = true; </span>
<span class="nc" id="L202">		String bindingKey = UDDIKeyConvention.getBindingKey(properties, serviceName, portName, serviceUrl);</span>
		//check if this bindingKey is in the service's binding templates
<span class="nc bnc" id="L204" title="All 2 branches missed.">		for (BindingTemplate bindingTemplate : service.getBindingTemplates().getBindingTemplate()) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">			if (bindingKey.equals(bindingTemplate.getBindingKey())) {</span>
<span class="nc" id="L206">				clerk.unRegisterBinding(bindingKey);</span>
				//if this is the last binding for this service, and 
<span class="nc bnc" id="L208" title="All 4 branches missed.">				if (service.getBindingTemplates().getBindingTemplate().size()==1 &amp;&amp; isRemoveServiceIfNoTemplates) {</span>
<span class="nc" id="L209">					clerk.unRegisterService(serviceKey);</span>
					
<span class="nc" id="L211">					FindTModel findTmodelForProcessName = createFindTModelForProcessName(serviceName);</span>
<span class="nc" id="L212">					TModelList tModelList = clerk.findTModel(findTmodelForProcessName);</span>
<span class="nc bnc" id="L213" title="All 6 branches missed.">					if (tModelList!=null &amp;&amp; tModelList.getTModelInfos()!=null &amp;&amp; tModelList.getTModelInfos().getTModelInfo()!=null) {</span>
<span class="nc" id="L214">						TModelInfo tModelInfo = tModelList.getTModelInfos().getTModelInfo().get(0);</span>
<span class="nc" id="L215">						String bpel4WSTModelKey = tModelInfo.getTModelKey();</span>
<span class="nc" id="L216">						clerk.unRegisterTModel(bpel4WSTModelKey);</span>
						// now use this key to find the portType TModels
<span class="nc" id="L218">						GetTModelDetail findAllPortTypesForProcess = createFindAllPortTypesForProcess_1(bpel4WSTModelKey);</span>
<span class="nc" id="L219">						TModelDetail tModelDetail = clerk.getTModelDetail(findAllPortTypesForProcess);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">						if (tModelDetail!=null) {</span>
<span class="nc" id="L221">							List&lt;TModel&gt; tModelPortTypeList = tModelDetail.getTModel();</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">							if (tModelPortTypeList!=null &amp;&amp; tModelPortTypeList.size()&gt;0) {</span>
<span class="nc" id="L223">								TModel bpel4WSTModel = tModelPortTypeList.get(0);</span>
<span class="nc" id="L224">								CategoryBag categoryBag = bpel4WSTModel.getCategoryBag();</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">								if (categoryBag!=null &amp;&amp; categoryBag.getKeyedReference()!=null) {</span>
<span class="nc" id="L226">									List&lt;KeyedReference&gt; portTypeTModelKeys = new ArrayList&lt;KeyedReference&gt;();</span>
<span class="nc" id="L227">									KeyedReference namespaceRef = null;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">									for (KeyedReference keyedReference : categoryBag.getKeyedReference()) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">										if (&quot;uddi:uddi.org:wsdl:porttypereference&quot;.equals(keyedReference.getTModelKey()) ) {</span>
<span class="nc" id="L230">											portTypeTModelKeys.add(keyedReference);</span>
										}
<span class="nc bnc" id="L232" title="All 2 branches missed.">										if (&quot;uddi:uddi.org:xml:namespace&quot;.equals(keyedReference.getTModelKey()) ) {</span>
<span class="nc" id="L233">											namespaceRef = keyedReference;</span>
										}
<span class="nc" id="L235">									}</span>
<span class="nc" id="L236">									String namespace = null;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">									if (namespaceRef!=null) namespace = namespaceRef.getKeyValue();</span>
									//find the bindingTModel
<span class="nc bnc" id="L239" title="All 2 branches missed.">									for (KeyedReference keyedReference : portTypeTModelKeys) {</span>
<span class="nc" id="L240">										FindTModel findBindingTModel = WSDL2UDDI.createFindBindingTModelForPortType(keyedReference.getKeyValue(), namespace);</span>
<span class="nc" id="L241">										TModelList bindingTmodels = clerk.findTModel(findBindingTModel);</span>
<span class="nc bnc" id="L242" title="All 6 branches missed.">										if (bindingTmodels!=null &amp;&amp; bindingTmodels.getTModelInfos()!=null &amp;&amp; bindingTmodels.getTModelInfos().getTModelInfo()!=null) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">											for (TModelInfo bindingTModelInfo : bindingTmodels.getTModelInfos().getTModelInfo()) {</span>
												//delete the Binding TModel
<span class="nc" id="L245">												clerk.unRegisterTModel(bindingTModelInfo.getTModelKey());</span>
<span class="nc" id="L246">											}</span>
										}
										//delete the PortType TModel
<span class="nc" id="L249">										clerk.unRegisterTModel(keyedReference.getKeyValue());	</span>
<span class="nc" id="L250">									}</span>
 								}
							}
						}
					}
<span class="nc" id="L255">				}</span>
				break;
			}
<span class="nc" id="L258">		}</span>
<span class="nc" id="L259">		return service.getServiceKey();	</span>
	}
	/**
	 * Perform a lookup by serviceKey, and will return null if not found.
	 * @param serviceKey
	 * @return a business service
	 * @throws RemoteException
	 * @throws ConfigurationException
	 * @throws TransportException
	 */
	public BusinessService lookupService(String serviceKey) throws RemoteException, ConfigurationException, TransportException {
		
		//Checking if this serviceKey already exist
<span class="nc" id="L272">		BusinessService service = clerk.getServiceDetail(serviceKey);</span>
<span class="nc" id="L273">		return service;</span>
	}
	/**
	 * Registers the Service into UDDI.
	 * 
	 * @param serviceName
	 * @param wsdlDefinition
	 * @return a business service
	 */
	public BusinessService createBusinessService(QName serviceName, Definition wsdlDefinition) {
		
<span class="nc" id="L284">		log.debug(&quot;Constructing Service UDDI Information for &quot; + serviceName);</span>
<span class="nc" id="L285">		BusinessService service = new BusinessService();</span>
		// BusinessKey
<span class="nc" id="L287">		service.setBusinessKey(businessKey);</span>
		// ServiceKey
<span class="nc" id="L289">		service.setServiceKey(UDDIKeyConvention.getServiceKey(properties, serviceName.getLocalPart()));</span>
		// Description
<span class="nc" id="L291">		String serviceDescription = properties.getProperty(Property.SERVICE_DESCRIPTION, Property.DEFAULT_SERVICE_DESCRIPTION);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">		if (wsdlDefinition.getService(serviceName) !=null) {</span>
			// Override with the service description from the WSDL if present
<span class="nc" id="L294">			Element docElement = wsdlDefinition.getService(serviceName).getDocumentationElement();</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">			if (docElement!=null &amp;&amp; docElement.getTextContent()!=null) {</span>
<span class="nc" id="L296">				serviceDescription = docElement.getTextContent();</span>
			}
		}
		
<span class="nc" id="L300">		service.getDescription().addAll(Common2UDDI.mapDescription(serviceDescription, lang));</span>
		// Service name
<span class="nc" id="L302">		Name sName = new Name();</span>
<span class="nc" id="L303">		sName.setLang(lang);</span>
<span class="nc" id="L304">		sName.setValue(serviceName.getLocalPart());</span>
<span class="nc" id="L305">		service.getName().add(sName);</span>
		
		//customization to add KeyedReferences into the categoryBag of the service
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (properties.containsKey(Property.SERVICE_CATEGORY_BAG)) {</span>
<span class="nc" id="L309">			String serviceCategoryBag = properties.getProperty(Property.SERVICE_CATEGORY_BAG);</span>
<span class="nc" id="L310">			log.debug(&quot;Adding KeyedReferences '&quot; +  serviceCategoryBag + &quot;' to service &quot; + serviceName.getLocalPart());</span>
<span class="nc" id="L311">			CategoryBag categoryBag = parseCategoryBag(serviceCategoryBag);</span>
<span class="nc" id="L312">	        service.setCategoryBag(categoryBag);</span>
		}
		
<span class="nc" id="L315">		return service;</span>
	}
	
	public Set&lt;TModel&gt; createWSDLPortTypeTModels(String wsdlURL, Map&lt;QName,PortType&gt; portTypes) throws WSDLException 
	{
<span class="fc" id="L320">		return wsdl2UDDI.createWSDLPortTypeTModels(wsdlURL, portTypes);</span>
	}
	
	public Set&lt;TModel&gt; createWSDLBindingTModels(String wsdlURL, Map&lt;QName,Binding&gt; bindings) throws WSDLException 
	{
<span class="fc" id="L325">		return wsdl2UDDI.createWSDLBindingTModels(wsdlURL, bindings);</span>
	}
	
	/**
	 * BPEL4WS abstract processes are published as separate UDDI tModels. They are named with the BPEL4WS process 
	 * name. They are categorized as BPEL4WS process definitions, using a category system defined in this 
	 * technical note. Their overviewDoc references an external BPEL4WS document that contains the process definition.
	 * All WSDL portTypes that are used in the BPEL4WS process definition (via the referenced BPEL4WS partnerLinkTypes) 
	 * are published as portType tModels according to [WSDL2UDDI]. The process tModel references all such WSDL portType
	 * tModels, using the WSDL portType Reference tModel defined in [WSDL2UDDI]. Note that it is a characteristic 
	 * of the BPEL4WS process that it defines a conversation based on WSDL portTypes. Thus, the relationship 
	 * between process tModel and portType tModel is to be published by the process tModel publisher, not by 
	 * the portType tModel publisher, which may be a different person.
	 * 
	 * In the current implementation it is all registered by the same publisher. 
	 * 
	 * @param serviceName
	 * @param targetNamespace
	 * @param portTypes
	 * @param bpelOverviewURL
	 * @return tmodels
	 */
    public TModel createBPEL4WSProcessTModel(QName serviceName, String targetNamespace, Map&lt;QName,PortType&gt; portTypes, String bpelOverviewURL) {
<span class="fc" id="L348">    	TModel tModel = new TModel();</span>
    	// Set the Key
<span class="fc" id="L350">    	tModel.setTModelKey(keyDomainURI + serviceName.getLocalPart() + &quot;Process&quot;);</span>
    	// Set the Name
<span class="fc" id="L352">    	Name name = new Name();</span>
<span class="fc" id="L353">    	name.setLang(&quot;en&quot;);</span>
<span class="fc" id="L354">    	name.setValue(serviceName.getLocalPart());</span>
<span class="fc" id="L355">    	tModel.setName(name);</span>
    	// Set the OverviewURL
<span class="fc" id="L357">    	OverviewURL overviewURL = new OverviewURL();</span>
<span class="fc" id="L358">    	overviewURL.setValue(&quot;http://localhost:8080/bpel-console/&quot;); //should point to the bpel of this process, maybe in guvnor</span>
<span class="fc" id="L359">    	OverviewDoc overviewDoc = new OverviewDoc();</span>
<span class="fc" id="L360">    	overviewDoc.setOverviewURL(overviewURL);</span>
<span class="fc" id="L361">    	tModel.getOverviewDoc().add(overviewDoc);</span>
    	// Set the categoryBag
<span class="fc" id="L363">    	CategoryBag categoryBag = new CategoryBag();</span>
    	
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">    	if (targetNamespace!=null) {</span>
<span class="fc" id="L366">    		KeyedReference namespaceReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:xml:namespace&quot;, &quot;uddi-org:xml:namespace&quot;, targetNamespace);
<span class="fc" id="L368">    		categoryBag.getKeyedReference().add(namespaceReference);</span>
    	}
<span class="fc" id="L370">    	KeyedReference typesReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:bpel:types&quot;, &quot;uddi-org:bpel:types&quot;, &quot;process&quot;);
<span class="fc" id="L372">    	categoryBag.getKeyedReference().add(typesReference);</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">    	for (QName qName : portTypes.keySet()) {</span>
<span class="fc" id="L374">    		String portTypeKey = keyDomainURI + qName.getLocalPart();</span>
<span class="fc" id="L375">	    	KeyedReference portTypeReference = WSDL2UDDI.newKeyedReference(</span>
	    			&quot;uddi:uddi.org:wsdl:porttypereference&quot;, &quot;uddi-org:wsdl:portTypeReference&quot;, portTypeKey);
<span class="fc" id="L377">	    	categoryBag.getKeyedReference().add(portTypeReference);</span>
<span class="fc" id="L378">    	}</span>
    	
<span class="fc" id="L380">    	tModel.setCategoryBag(categoryBag);</span>
    	
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">    	if (log.isDebugEnabled()) {</span>
<span class="nc" id="L383">    		log.debug(new PrintUDDI&lt;TModel&gt;().print(tModel));</span>
    	}
    	
<span class="fc" id="L386">    	return tModel;</span>
    }
    
    public BindingTemplate createBPELBinding(QName serviceName, String portName, URL serviceUrl, Definition wsdlDefinition) {
		
<span class="fc" id="L391">    	BindingTemplate bindingTemplate = new BindingTemplate();</span>
		// Set BusinessService Key
<span class="fc" id="L393">		bindingTemplate.setServiceKey(UDDIKeyConvention.getServiceKey(properties, serviceName.getLocalPart()));</span>
		// Set Binding Key
<span class="fc" id="L395">		String bindingKey = UDDIKeyConvention.getBindingKey(properties, serviceName, portName, serviceUrl);</span>
<span class="fc" id="L396">		bindingTemplate.setBindingKey(bindingKey);</span>
		// Set AccessPoint
<span class="fc" id="L398">		AccessPoint accessPoint = new AccessPoint();</span>
<span class="fc" id="L399">		accessPoint.setUseType(AccessPointType.END_POINT.toString());</span>
<span class="fc" id="L400">		accessPoint.setValue(urlLocalizer.rewrite(serviceUrl));</span>
<span class="fc" id="L401">		bindingTemplate.setAccessPoint(accessPoint);</span>
		
<span class="fc" id="L403">		Service service =  wsdlDefinition.getService(serviceName);</span>
		
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">		if (service!=null) {</span>
<span class="fc" id="L406">			TModelInstanceDetails tModelInstanceDetails = new TModelInstanceDetails();</span>
			
<span class="fc" id="L408">			Port port = service.getPort(portName);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">			if (port!=null) {</span>
<span class="fc" id="L410">				Binding binding = port.getBinding();</span>
				// Set the Binding Description
<span class="fc" id="L412">				String bindingDescription = properties.getProperty(Property.BINDING_DESCRIPTION, Property.DEFAULT_BINDING_DESCRIPTION);</span>
				// Override with the service description from the WSDL if present
<span class="fc" id="L414">				Element docElement = binding.getDocumentationElement();</span>
<span class="pc bpc" id="L415" title="3 of 4 branches missed.">				if (docElement!=null &amp;&amp; docElement.getTextContent()!=null) {</span>
<span class="nc" id="L416">					bindingDescription = docElement.getTextContent();</span>
				}
				
<span class="fc" id="L419">				bindingTemplate.getDescription().addAll(Common2UDDI.mapDescription(bindingDescription, lang));</span>
				
				// reference wsdl:binding tModel
<span class="fc" id="L422">				TModelInstanceInfo tModelInstanceInfoBinding = new TModelInstanceInfo();</span>
<span class="fc" id="L423">				tModelInstanceInfoBinding.setTModelKey(keyDomainURI + binding.getQName().getLocalPart());</span>
<span class="fc" id="L424">				InstanceDetails instanceDetails = new InstanceDetails();</span>
<span class="fc" id="L425">				instanceDetails.setInstanceParms(portName);  </span>
<span class="fc" id="L426">				tModelInstanceInfoBinding.setInstanceDetails(instanceDetails);</span>
				
<span class="fc" id="L428">				tModelInstanceInfoBinding.getDescription().addAll(Common2UDDI.mapDescription(&quot;The wsdl:binding that this wsdl:port implements. &quot; + bindingDescription +</span>
						&quot; The instanceParms specifies the port local name.&quot;, lang));
<span class="fc" id="L430">				tModelInstanceDetails.getTModelInstanceInfo().add(tModelInstanceInfoBinding);</span>
				
				// reference wsdl:portType tModel
<span class="fc" id="L433">				PortType portType = binding.getPortType();</span>
<span class="fc" id="L434">				TModelInstanceInfo tModelInstanceInfoPortType = new TModelInstanceInfo();</span>
<span class="fc" id="L435">				tModelInstanceInfoPortType.setTModelKey(keyDomainURI + portType.getQName().getLocalPart());</span>
<span class="fc" id="L436">				String portTypeDescription = &quot;&quot;;</span>
<span class="fc" id="L437">				docElement = portType.getDocumentationElement();</span>
<span class="pc bpc" id="L438" title="3 of 4 branches missed.">				if (docElement!=null &amp;&amp; docElement.getTextContent()!=null) {</span>
<span class="nc" id="L439">					portTypeDescription = docElement.getTextContent();</span>
				}
				
<span class="fc" id="L442">				tModelInstanceInfoPortType.getDescription().addAll(Common2UDDI.mapDescription(&quot;The wsdl:portType that this wsdl:port implements.&quot; + portTypeDescription, lang));</span>
<span class="fc" id="L443">				tModelInstanceDetails.getTModelInstanceInfo().add(tModelInstanceInfoPortType);</span>
				
				//reference bpel:process tModel
<span class="fc" id="L446">				TModelInstanceInfo tModelInstanceInfoBPEL = new TModelInstanceInfo();</span>
<span class="fc" id="L447">				tModelInstanceInfoBPEL.setTModelKey(keyDomainURI + service.getQName().getLocalPart() + &quot;Process&quot;);</span>
				
				// Description
<span class="fc" id="L450">				String serviceDescription = properties.getProperty(Property.SERVICE_DESCRIPTION, Property.DEFAULT_SERVICE_DESCRIPTION);</span>
				// Override with the service description from the WSDL if present
<span class="fc" id="L452">				docElement = wsdlDefinition.getService(serviceName).getDocumentationElement();</span>
<span class="pc bpc" id="L453" title="3 of 4 branches missed.">				if (docElement!=null &amp;&amp; docElement.getTextContent()!=null) {</span>
<span class="nc" id="L454">					serviceDescription = docElement.getTextContent();</span>
				}
				
<span class="fc" id="L457">				tModelInstanceInfoBPEL.getDescription().addAll(Common2UDDI.mapDescription(&quot;The bpel:process this wsdl:port supports.&quot; + serviceDescription, lang));</span>
<span class="fc" id="L458">				tModelInstanceDetails.getTModelInstanceInfo().add(tModelInstanceInfoBPEL);</span>
				
<span class="fc" id="L460">				bindingTemplate.setTModelInstanceDetails(tModelInstanceDetails);</span>
<span class="fc" id="L461">			} else {</span>
<span class="nc" id="L462">				log.error(&quot;Could not find Port with portName: &quot; + portName);</span>
			}
<span class="fc" id="L464">		} else {</span>
<span class="nc" id="L465">			log.error(&quot;Could not find Service with serviceName: &quot; + serviceName.getLocalPart());</span>
		}
		
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if (log.isDebugEnabled()) {</span>
<span class="nc" id="L469">    		log.debug(new PrintUDDI&lt;BindingTemplate&gt;().print(bindingTemplate));</span>
    	}
		
<span class="fc" id="L472">		return bindingTemplate;</span>
	}
    
    /** Finds and returns ALL the tModels related to the process, so that i.e. they
     * can be removed on undeployment of the service.
     * 
     * @param serviceName
     * @return a tModel if found
     */
    public FindTModel createFindTModelForProcessName (QName serviceName) {
    	
<span class="fc" id="L483">    	FindTModel findTModel = new FindTModel();</span>
<span class="fc" id="L484">    	Name name = new Name();</span>
    	//name.setLang(lang);
<span class="fc" id="L486">    	name.setValue(serviceName.getLocalPart());</span>
<span class="fc" id="L487">    	findTModel.setName(name);</span>
<span class="fc" id="L488">    	CategoryBag categoryBag = new CategoryBag();</span>
    	
<span class="fc" id="L490">    	String namespace = serviceName.getNamespaceURI();</span>
<span class="pc bpc" id="L491" title="2 of 4 branches missed.">    	if (namespace!=null &amp;&amp; namespace.length()!=0) {</span>
<span class="fc" id="L492">    		KeyedReference namespaceReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:xml:namespace&quot;, &quot;uddi-org:xml:namespace&quot;, namespace);
<span class="fc" id="L494">    		categoryBag.getKeyedReference().add(namespaceReference);</span>
    	}
<span class="fc" id="L496">    	KeyedReference typesReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:bpel:types&quot;, &quot;uddi-org:bpel:types&quot;, &quot;process&quot;);
<span class="fc" id="L498">    	categoryBag.getKeyedReference().add(typesReference);</span>
<span class="fc" id="L499">    	findTModel.setCategoryBag(categoryBag);</span>
    	
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">    	if (log.isDebugEnabled()) {</span>
<span class="nc" id="L502">    		log.debug(new PrintUDDI&lt;FindTModel&gt;().print(findTModel));</span>
    	}
<span class="fc" id="L504">    	return findTModel;</span>
    }
    /**
     * Find all processes that use the given portType.
     * 
     * @param portTypeKey
     * @return tmodel info
     */
    public FindTModel createFindProcessesForPortTypes(String portTypeKey) {
<span class="nc" id="L513">    	FindTModel findTModel = new FindTModel();</span>
<span class="nc" id="L514">    	CategoryBag categoryBag = new CategoryBag();</span>
    	
<span class="nc" id="L516">    	KeyedReference typesReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:bpel:types&quot;, &quot;uddi-org:bpel:types&quot;, &quot;process&quot;);
<span class="nc" id="L518">    	categoryBag.getKeyedReference().add(typesReference);</span>
    	
<span class="nc" id="L520">    	KeyedReference portTypeReference = WSDL2UDDI.newKeyedReference(</span>
    			&quot;uddi:uddi.org:wsdl:porttypereference&quot;, &quot;uddi-org:wsdl:portTypeReference&quot;, portTypeKey);
<span class="nc" id="L522">    	categoryBag.getKeyedReference().add(portTypeReference);</span>
    	
<span class="nc" id="L524">    	findTModel.setCategoryBag(categoryBag);</span>
    	
<span class="nc" id="L526">    	return findTModel;</span>
    }
    /**
     * Find all portTypes used in the given process. This should return the 
     * tModel registration for the process tModel. The tModelKeys for the 
     * portTypes used in the process can be obtained from the process tModels 
     * categoryBag, and passed into the second call.
     * 
     * @param processKey
     * @return GetTModelDetail
     */
    public GetTModelDetail createFindAllPortTypesForProcess_1(String processKey) {
<span class="nc" id="L538">    	GetTModelDetail getTModelDetail = new GetTModelDetail();</span>
<span class="nc" id="L539">    	getTModelDetail.getTModelKey().add(processKey);</span>
<span class="nc" id="L540">    	return getTModelDetail;</span>
    }
    /**
     * Once retrieved, the second call is made to get the tModel registrations 
     * for the portTypes with the keys found in the first step.
     * 
     * @param portTypeTModelKeys - List of portType tModels found in the first step.
     * @return GetTModelDetail
     */
    public GetTModelDetail createFindAllPortTypesForProcess_2(List&lt;String&gt; portTypeTModelKeys) {
<span class="nc" id="L550">    	GetTModelDetail getTModelDetail = new GetTModelDetail();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">    	for (String tModelKey : portTypeTModelKeys) {</span>
<span class="nc" id="L552">    		getTModelDetail.getTModelKey().add(tModelKey);</span>
<span class="nc" id="L553">    	}</span>
<span class="nc" id="L554">    	return getTModelDetail;</span>
    }
    /**
     * Find all implementations of the given process.
     * @param processKey
     * @return FindBinding
     */
    public FindBinding createFindImplementationsForProcess(String processKey) {
<span class="nc" id="L562">    	FindBinding findBinding = new FindBinding();</span>
<span class="nc" id="L563">    	TModelBag tModelBag = new TModelBag();</span>
<span class="nc" id="L564">    	tModelBag.getTModelKey().add(processKey);</span>
<span class="nc" id="L565">    	return findBinding;</span>
    }
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>