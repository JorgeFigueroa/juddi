<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JUDDIApiImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jUDDI Core - OpenJPA</a> &gt; <a href="index.source.html" class="el_package">org.apache.juddi.api.impl</a> &gt; <span class="el_source">JUDDIApiImpl.java</span></div><h1>JUDDIApiImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001-2008 The Apache Software Foundation.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
package org.apache.juddi.api.impl;

import java.io.StringWriter;
import java.math.BigInteger;
import java.rmi.RemoteException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.jws.WebService;
import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;
import javax.persistence.Query;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.Marshaller;
import javax.xml.ws.Holder;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.juddi.ClassUtil;
import static org.apache.juddi.api.impl.JUDDIApiImpl.sub;
import org.apache.juddi.api.util.JUDDIQuery;
import org.apache.juddi.api.util.QueryStatus;
import org.apache.juddi.api_v3.AdminSaveBusinessWrapper;
import org.apache.juddi.api_v3.AdminSaveTModelWrapper;
import org.apache.juddi.api_v3.Clerk;
import org.apache.juddi.api_v3.ClerkDetail;
import org.apache.juddi.api_v3.ClerkList;
import org.apache.juddi.api_v3.ClientSubscriptionInfoDetail;
import org.apache.juddi.api_v3.DeleteClerk;
import org.apache.juddi.api_v3.DeleteClientSubscriptionInfo;
import org.apache.juddi.api_v3.DeleteNode;
import org.apache.juddi.api_v3.DeletePublisher;
import org.apache.juddi.api_v3.GetAllClientSubscriptionInfoDetail;
import org.apache.juddi.api_v3.GetAllPublisherDetail;
import org.apache.juddi.api_v3.GetClientSubscriptionInfoDetail;
import org.apache.juddi.api_v3.GetEntityHistoryMessageRequest;
import org.apache.juddi.api_v3.GetEntityHistoryMessageResponse;
import org.apache.juddi.api_v3.GetFailedReplicationChangeRecordsMessageRequest;
import org.apache.juddi.api_v3.GetFailedReplicationChangeRecordsMessageResponse;
import org.apache.juddi.api_v3.GetPublisherDetail;
import org.apache.juddi.api_v3.NodeDetail;
import org.apache.juddi.api_v3.NodeList;
import org.apache.juddi.api_v3.PublisherDetail;
import org.apache.juddi.api_v3.SaveClerk;
import org.apache.juddi.api_v3.SaveClientSubscriptionInfo;
import org.apache.juddi.api_v3.SaveNode;
import org.apache.juddi.api_v3.SavePublisher;
import org.apache.juddi.api_v3.SubscriptionWrapper;
import org.apache.juddi.api_v3.SyncSubscription;
import org.apache.juddi.api_v3.SyncSubscriptionDetail;
import org.apache.juddi.config.AppConfig;
import org.apache.juddi.config.PersistenceManager;
import org.apache.juddi.config.Property;
import org.apache.juddi.mapping.MappingApiToModel;
import org.apache.juddi.mapping.MappingModelToApi;
import org.apache.juddi.model.BusinessEntity;
import org.apache.juddi.model.ChangeRecord;
import org.apache.juddi.model.ClientSubscriptionInfo;
import org.apache.juddi.model.Node;
import org.apache.juddi.model.Publisher;
import org.apache.juddi.model.ReplicationConfiguration;
import org.apache.juddi.model.Tmodel;
import org.apache.juddi.model.UddiEntityPublisher;
import org.apache.juddi.replication.ReplicationNotifier;
import org.apache.juddi.subscription.NotificationList;
import org.apache.juddi.subscription.notify.TemporaryMailContainer;
import org.apache.juddi.subscription.notify.USERFRIENDLYSMTPNotifier;
import org.apache.juddi.v3.client.transport.Transport;
import org.apache.juddi.v3.error.ErrorMessage;
import org.apache.juddi.v3.error.FatalErrorException;
import org.apache.juddi.v3.error.InvalidKeyPassedException;
import org.apache.juddi.v3.error.InvalidValueException;
import org.apache.juddi.v3.error.UserMismatchException;
import org.apache.juddi.v3_service.JUDDIApiPortType;
import org.apache.juddi.validation.ValidateClerk;
import org.apache.juddi.validation.ValidateClientSubscriptionInfo;
import org.apache.juddi.validation.ValidateNode;
import org.apache.juddi.validation.ValidatePublish;
import org.apache.juddi.validation.ValidatePublisher;
import org.apache.juddi.validation.ValidateReplication;
import org.uddi.api_v3.AuthToken;
import org.uddi.api_v3.BusinessInfo;
import org.uddi.api_v3.BusinessInfos;
import org.uddi.api_v3.Contact;
import org.uddi.api_v3.DeleteTModel;
import org.uddi.api_v3.DispositionReport;
import org.uddi.api_v3.GetRegisteredInfo;
import org.uddi.api_v3.InfoSelection;
import org.uddi.api_v3.PersonName;
import org.uddi.api_v3.RegisteredInfo;
import org.uddi.api_v3.Result;
import org.uddi.api_v3.SaveBusiness;
import org.uddi.api_v3.SaveTModel;
import org.uddi.api_v3.TModelInfo;
import org.uddi.api_v3.TModelInfos;
import org.uddi.repl_v3.ChangeRecords;
import org.uddi.repl_v3.CommunicationGraph;
import org.uddi.repl_v3.Operator;
import org.uddi.repl_v3.OperatorStatusType;
import org.uddi.sub_v3.GetSubscriptionResults;
import org.uddi.sub_v3.Subscription;
import org.uddi.sub_v3.SubscriptionResultsList;
import org.uddi.v3_service.DispositionReportFaultMessage;
import org.uddi.v3_service.UDDISubscriptionPortType;

/**
 * Implements the jUDDI API service. These methods are outside of the UDDI spec
 * and are specific to jUDDI. They are primarily used for administrative
 * functions.
 *
 * @author &lt;a href=&quot;mailto:jfaath@apache.org&quot;&gt;Jeff Faath&lt;/a&gt;
 * @author &lt;a href=&quot;mailto:kstam@apache.org&quot;&gt;Kurt T Stam&lt;/a&gt;
 * @author &lt;a href=&quot;mailto:alexoree@apache.org&quot;&gt;Alex O'Ree&lt;/a&gt;
 */
@WebService(serviceName = &quot;JUDDIApiService&quot;,
        endpointInterface = &quot;org.apache.juddi.v3_service.JUDDIApiPortType&quot;,
        targetNamespace = &quot;urn:juddi-apache-org:v3_service&quot;, wsdlLocation = &quot;classpath:/juddi_api_v1.wsdl&quot;)
<span class="fc" id="L139">public class JUDDIApiImpl extends AuthenticatedService implements JUDDIApiPortType {</span>

<span class="fc" id="L141">        private Log log = LogFactory.getLog(this.getClass());</span>
<span class="fc" id="L142">        private UDDIServiceCounter serviceCounter = ServiceCounterLifecycleResource.getServiceCounter(this.getClass());</span>

        /**
         * Saves publisher(s) to the persistence layer. This method is specific
         * to jUDDI. Administrative privilege required.
         *
         * @param body
         * @return PublisherDetail
         * @throws DispositionReportFaultMessage
         */
        public PublisherDetail savePublisher(SavePublisher body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L154">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L155">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L156">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L158">                        tx.begin();</span>

<span class="fc" id="L160">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L162">                        new ValidatePublish(publisher).validateSavePublisher(em, body);</span>

<span class="fc" id="L164">                        PublisherDetail result = new PublisherDetail();</span>

<span class="fc" id="L166">                        List&lt;org.apache.juddi.api_v3.Publisher&gt; apiPublisherList = body.getPublisher();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">                        for (org.apache.juddi.api_v3.Publisher apiPublisher : apiPublisherList) {</span>

<span class="fc" id="L169">                                org.apache.juddi.model.Publisher modelPublisher = new org.apache.juddi.model.Publisher();</span>

<span class="fc" id="L171">                                MappingApiToModel.mapPublisher(apiPublisher, modelPublisher);</span>

<span class="fc" id="L173">                                Object existingUddiEntity = em.find(modelPublisher.getClass(), modelPublisher.getAuthorizedName());</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">                                if (existingUddiEntity != null) {</span>
<span class="fc" id="L175">                                        em.remove(existingUddiEntity);</span>
                                }

<span class="fc" id="L178">                                em.persist(modelPublisher);</span>

<span class="fc" id="L180">                                result.getPublisher().add(apiPublisher);</span>
<span class="fc" id="L181">                        }</span>

<span class="fc" id="L183">                        tx.commit();</span>
<span class="fc" id="L184">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L185">                        serviceCounter.update(JUDDIQuery.SAVE_PUBLISHER,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L187">                        return result;</span>
<span class="nc" id="L188">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L189">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L190">                        serviceCounter.update(JUDDIQuery.SAVE_PUBLISHER,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L192">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L194" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L195">                                tx.rollback();</span>
                        }
<span class="pc" id="L197">                        em.close();</span>
                }
        }

        /**
         * Deletes publisher(s) from the persistence layer. This method is
         * specific to jUDDI. Administrative privilege required. Also removes
         * all registered business entities of the user and marks all created
         * tModels as &quot;deleted&quot; but not does not remove the tModel from
         * persistence. All subscriptions are also destroyed
         *
         * @param body
         * @throws DispositionReportFaultMessage
         */
        @Override
        public void deletePublisher(DeletePublisher body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L214">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L215">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L216">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L218">                        tx.begin();</span>

<span class="fc" id="L220">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L222">                        new ValidatePublish(publisher).validateDeletePublisher(em, body);</span>

<span class="fc" id="L224">                        List&lt;String&gt; entityKeyList = body.getPublisherId();</span>
<span class="fc" id="L225">                        List&lt;Publisher&gt; deletedPubs = new ArrayList&lt;Publisher&gt;();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                        for (String entityKey : entityKeyList) {</span>
<span class="fc" id="L227">                                Publisher obj = em.find(org.apache.juddi.model.Publisher.class, entityKey);</span>
<span class="fc" id="L228">                                deletedPubs.add(obj);</span>
                                //get an authtoken for this publisher so that we can get its registeredInfo
<span class="fc" id="L230">                                UDDISecurityImpl security = new UDDISecurityImpl();</span>
<span class="fc" id="L231">                                AuthToken authToken = security.getAuthToken(entityKey);</span>

<span class="fc" id="L233">                                GetRegisteredInfo r = new GetRegisteredInfo();</span>
<span class="fc" id="L234">                                r.setAuthInfo(authToken.getAuthInfo());</span>
<span class="fc" id="L235">                                r.setInfoSelection(InfoSelection.ALL);</span>

<span class="fc" id="L237">                                log.info(&quot;removing all businesses owned by publisher &quot; + entityKey + &quot;.&quot;);</span>
<span class="fc" id="L238">                                UDDIPublicationImpl publish = new UDDIPublicationImpl();</span>
<span class="fc" id="L239">                                RegisteredInfo registeredInfo = publish.getRegisteredInfo(r);</span>
<span class="fc" id="L240">                                BusinessInfos businessInfos = registeredInfo.getBusinessInfos();</span>
<span class="pc bpc" id="L241" title="3 of 4 branches missed.">                                if (businessInfos != null &amp;&amp; businessInfos.getBusinessInfo() != null) {</span>
<span class="nc" id="L242">                                        Iterator&lt;BusinessInfo&gt; iter = businessInfos.getBusinessInfo().iterator();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                                        while (iter.hasNext()) {</span>
<span class="nc" id="L244">                                                BusinessInfo businessInfo = iter.next();</span>
<span class="nc" id="L245">                                                Object business = em.find(org.apache.juddi.model.BusinessEntity.class, businessInfo.getBusinessKey());</span>
<span class="nc" id="L246">                                                em.remove(business);</span>
<span class="nc" id="L247">                                        }</span>
                                }

<span class="fc" id="L250">                                log.info(&quot;mark all tmodels for publisher &quot; + entityKey + &quot; as deleted.&quot;);</span>
<span class="fc" id="L251">                                TModelInfos tmodelInfos = registeredInfo.getTModelInfos();</span>
<span class="pc bpc" id="L252" title="3 of 4 branches missed.">                                if (tmodelInfos != null &amp;&amp; tmodelInfos.getTModelInfo() != null) {</span>
<span class="nc" id="L253">                                        Iterator&lt;TModelInfo&gt; iter = tmodelInfos.getTModelInfo().iterator();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                                        while (iter.hasNext()) {</span>
<span class="nc" id="L255">                                                TModelInfo tModelInfo = iter.next();</span>
<span class="nc" id="L256">                                                Tmodel tmodel = (Tmodel) em.find(org.apache.juddi.model.Tmodel.class, tModelInfo.getTModelKey());</span>
<span class="nc" id="L257">                                                tmodel.setDeleted(true);</span>
<span class="nc" id="L258">                                                em.persist(tmodel);</span>
<span class="nc" id="L259">                                        }</span>
                                }
<span class="fc" id="L261">                                log.info(&quot;remove all persisted AuthTokens for publisher &quot; + entityKey + &quot;.&quot;);</span>
<span class="fc" id="L262">                                Query q1 = em.createQuery(&quot;DELETE FROM AuthToken auth WHERE auth.authorizedName = ?1&quot;);</span>
<span class="fc" id="L263">                                q1.setParameter(1, entityKey);</span>
<span class="fc" id="L264">                                q1.executeUpdate();</span>
<span class="fc" id="L265">                                log.info(&quot;remove all subscriptions for publisher &quot; + entityKey + &quot;.&quot;);</span>
<span class="fc" id="L266">                                q1 = em.createQuery(&quot;DELETE FROM Subscription s WHERE s.authorizedName = ?1&quot;);</span>
<span class="fc" id="L267">                                q1.setParameter(1, entityKey);</span>
<span class="fc" id="L268">                                q1.executeUpdate();</span>

<span class="fc" id="L270">                                log.info(&quot;removing publisher &quot; + entityKey + &quot;.&quot;);</span>
                                //delete the publisher
<span class="fc" id="L272">                                em.remove(obj);</span>
<span class="fc" id="L273">                        }</span>

<span class="fc" id="L275">                        tx.commit();</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">                        for (Publisher p: deletedPubs){</span>
<span class="fc" id="L277">                                USERFRIENDLYSMTPNotifier.notifyAccountDeleted(new TemporaryMailContainer(null, p, (Publisher) publisher));</span>
<span class="fc" id="L278">                        }</span>
<span class="fc" id="L279">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L280">                        serviceCounter.update(JUDDIQuery.DELETE_PUBLISHER,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L282">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L283">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L284">                        serviceCounter.update(JUDDIQuery.DELETE_PUBLISHER,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L286">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L288" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L289">                                tx.rollback();</span>
                        }
<span class="pc" id="L291">                        em.close();</span>
<span class="fc" id="L292">                }</span>
<span class="fc" id="L293">        }</span>

        /**
         * Retrieves publisher(s) from the persistence layer. This method is
         * specific to jUDDI. Administrative privilege required.
         *
         * @param body
         * @return PublisherDetail
         * @throws DispositionReportFaultMessage
         */
        public PublisherDetail getPublisherDetail(GetPublisherDetail body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L305">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L306">                new ValidatePublisher(null).validateGetPublisherDetail(body);</span>

<span class="fc" id="L308">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L309">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L311">                        tx.begin();</span>

<span class="fc" id="L313">                        this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L315">                        PublisherDetail result = new PublisherDetail();</span>

<span class="fc" id="L317">                        List&lt;String&gt; publisherIdList = body.getPublisherId();</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">                        for (String publisherId : publisherIdList) {</span>
<span class="fc" id="L319">                                org.apache.juddi.model.Publisher modelPublisher = null;</span>
                                try {
<span class="fc" id="L321">                                        modelPublisher = em.find(org.apache.juddi.model.Publisher.class, publisherId);</span>
<span class="nc" id="L322">                                } catch (ClassCastException e) {</span>
<span class="fc" id="L323">                                }</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">                                if (modelPublisher == null) {</span>
<span class="fc" id="L325">                                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.invalidkey.PublisherNotFound&quot;, publisherId));</span>
                                }

<span class="fc" id="L328">                                org.apache.juddi.api_v3.Publisher apiPublisher = new org.apache.juddi.api_v3.Publisher();</span>

<span class="fc" id="L330">                                MappingModelToApi.mapPublisher(modelPublisher, apiPublisher);</span>

<span class="fc" id="L332">                                result.getPublisher().add(apiPublisher);</span>
<span class="fc" id="L333">                        }</span>

<span class="fc" id="L335">                        tx.commit();</span>
<span class="fc" id="L336">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L337">                        serviceCounter.update(JUDDIQuery.GET_PUBLISHER_DETAIL,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L339">                        return result;</span>
<span class="fc" id="L340">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="fc" id="L341">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L342">                        serviceCounter.update(JUDDIQuery.GET_PUBLISHER_DETAIL,</span>
                                QueryStatus.FAILED, procTime);
<span class="fc" id="L344">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L346" title="2 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="pc" id="L347">                                tx.rollback();</span>
                        }
<span class="fc" id="L349">                        em.close();</span>
                }

        }

        /**
         * Retrieves all publisher from the persistence layer. This method is
         * specific to jUDDI. Administrative privilege required. Use caution
         * when calling, result set is not bound. If there are many publishers,
         * it is possible to have a result set that is too large
         *
         * @param body
         * @return PublisherDetail
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        @SuppressWarnings(&quot;unchecked&quot;)
        public PublisherDetail getAllPublisherDetail(GetAllPublisherDetail body)
                throws DispositionReportFaultMessage, RemoteException {
<span class="nc" id="L368">                long startTime = System.currentTimeMillis();</span>
<span class="nc" id="L369">                new ValidatePublisher(null).validateGetAllPublisherDetail(body);</span>

<span class="nc" id="L371">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L372">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L374">                        tx.begin();</span>

<span class="nc" id="L376">                        this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="nc" id="L378">                        PublisherDetail result = new PublisherDetail();</span>

<span class="nc" id="L380">                        Query query = em.createQuery(&quot;SELECT p from Publisher as p&quot;);</span>
<span class="nc" id="L381">                        List&lt;Publisher&gt; modelPublisherList = query.getResultList();</span>

<span class="nc bnc" id="L383" title="All 2 branches missed.">                        for (Publisher modelPublisher : modelPublisherList) {</span>

<span class="nc" id="L385">                                org.apache.juddi.api_v3.Publisher apiPublisher = new org.apache.juddi.api_v3.Publisher();</span>

<span class="nc" id="L387">                                MappingModelToApi.mapPublisher(modelPublisher, apiPublisher);</span>

<span class="nc" id="L389">                                result.getPublisher().add(apiPublisher);</span>
<span class="nc" id="L390">                        }</span>

<span class="nc" id="L392">                        tx.commit();</span>
<span class="nc" id="L393">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L394">                        serviceCounter.update(JUDDIQuery.GET_ALL_PUBLISHER_DETAIL,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L396">                        return result;</span>
<span class="nc" id="L397">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L398">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L399">                        serviceCounter.update(JUDDIQuery.GET_ALL_PUBLISHER_DETAIL,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L401">                        throw drfm;</span>
                } finally {
<span class="nc bnc" id="L403" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L404">                                tx.rollback();</span>
                        }
<span class="nc" id="L406">                        em.close();</span>
                }
        }

        /**
         * Completely deletes a tModel from the persistence layer.
         * Administrative privilege required. All entities that reference this
         * tModel will no longer be able to use the tModel if jUDDI Option
         * Enforce referential Integrity is enabled.&lt;br&gt;
         * Required permission, you must be am administrator
         * {@link Property#JUDDI_ENFORCE_REFERENTIAL_INTEGRITY}. In addition,
         * tModels that are owned by another node via replication cannot be
         * deleted using this method and will throw an exception
         *
         *
         * @param body
         * @throws DispositionReportFaultMessage
         */
        @Override
        public void adminDeleteTModel(DeleteTModel body)
                throws DispositionReportFaultMessage {
<span class="nc" id="L427">                long startTime = System.currentTimeMillis();</span>
<span class="nc" id="L428">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L429">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L431">                        tx.begin();</span>

<span class="nc" id="L433">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="nc" id="L435">                        new ValidatePublish(publisher).validateAdminDeleteTModel(em, body);</span>

                        //TODO if referiental integrity is turned on, check to see if this is referenced anywhere and prevent the delete
<span class="nc" id="L438">                        List&lt;ChangeRecord&gt; changes = new ArrayList&lt;ChangeRecord&gt;();</span>
<span class="nc" id="L439">                        List&lt;String&gt; entityKeyList = body.getTModelKey();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                        for (String entityKey : entityKeyList) {</span>
<span class="nc" id="L441">                                org.apache.juddi.model.Tmodel obj = em.find(org.apache.juddi.model.Tmodel.class, entityKey);</span>

<span class="nc bnc" id="L443" title="All 2 branches missed.">                                if (obj == null) {</span>
<span class="nc" id="L444">                                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.invalidkey.TModelNotFound&quot;, entityKey));</span>
                                }
<span class="nc bnc" id="L446" title="All 2 branches missed.">                                if (!obj.getNodeId().equals(getNode())) {</span>
<span class="nc" id="L447">                                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.invalidkey.TModelNodeOwner&quot;, entityKey + &quot; this node &quot; + getNode() + &quot; owning node &quot; + obj.getNodeId()));</span>
                                }
<span class="nc" id="L449">                                em.remove(obj);</span>
<span class="nc" id="L450">                                changes.add(UDDIPublicationImpl.getChangeRecord_deleteTModelDelete(entityKey, getNode(), df));</span>

<span class="nc" id="L452">                        }</span>

<span class="nc" id="L454">                        tx.commit();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                        for (ChangeRecord cr : changes) {</span>
<span class="nc" id="L456">                                ReplicationNotifier.enqueue(cr);</span>
<span class="nc" id="L457">                        }</span>
<span class="nc" id="L458">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L459">                        serviceCounter.update(JUDDIQuery.ADMIN_DELETE_TMODEL,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L461">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L462">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L463">                        serviceCounter.update(JUDDIQuery.ADMIN_DELETE_TMODEL,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L465">                        throw drfm;</span>
                } finally {
<span class="nc bnc" id="L467" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L468">                                tx.rollback();</span>
                        }
<span class="nc" id="L470">                        em.close();</span>
<span class="nc" id="L471">                }</span>
<span class="nc" id="L472">        }</span>

        /**
         * Delete's a client's subscription information. This is typically used
         * for server to server subscriptions Administrative privilege required.
         *
         * @param body
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        public void deleteClientSubscriptionInfo(DeleteClientSubscriptionInfo body)
                throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L484">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L485">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L486">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L488">                        tx.begin();</span>

<span class="fc" id="L490">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L492">                        new ValidateClientSubscriptionInfo(publisher).validateDeleteClientSubscriptionInfo(em, body);</span>

<span class="fc" id="L494">                        List&lt;String&gt; entityKeyList = body.getSubscriptionKey();</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">                        for (String entityKey : entityKeyList) {</span>
<span class="fc" id="L496">                                Object obj = em.find(org.apache.juddi.model.ClientSubscriptionInfo.class, entityKey);</span>
<span class="fc" id="L497">                                em.remove(obj);</span>
<span class="fc" id="L498">                        }</span>

<span class="fc" id="L500">                        tx.commit();</span>
<span class="fc" id="L501">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L502">                        serviceCounter.update(JUDDIQuery.DELETE_CLIENT_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L504">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L505">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L506">                        serviceCounter.update(JUDDIQuery.DELETE_CLIENT_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L508">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L511" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L512">                                tx.rollback();</span>
                        }
<span class="pc" id="L514">                        em.close();</span>
<span class="fc" id="L515">                }</span>

<span class="fc" id="L517">        }</span>

        /**
         * Adds client subscription information. This effectively links a server
         * to serverr subscription to clerk Administrative privilege required.
         *
         * @param body
         * @return ClientSubscriptionInfoDetail
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        public ClientSubscriptionInfoDetail saveClientSubscriptionInfo(SaveClientSubscriptionInfo body)
                throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L530">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L531">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L532">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L534">                        tx.begin();</span>

<span class="fc" id="L536">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L538">                        new ValidateClientSubscriptionInfo(publisher).validateSaveClientSubscriptionInfo(em, body);</span>

<span class="fc" id="L540">                        ClientSubscriptionInfoDetail result = new ClientSubscriptionInfoDetail();</span>

<span class="fc" id="L542">                        List&lt;org.apache.juddi.api_v3.ClientSubscriptionInfo&gt; apiClientSubscriptionInfoList = body.getClientSubscriptionInfo();</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">                        for (org.apache.juddi.api_v3.ClientSubscriptionInfo apiClientSubscriptionInfo : apiClientSubscriptionInfoList) {</span>

<span class="fc" id="L545">                                org.apache.juddi.model.ClientSubscriptionInfo modelClientSubscriptionInfo = new org.apache.juddi.model.ClientSubscriptionInfo();</span>

<span class="fc" id="L547">                                MappingApiToModel.mapClientSubscriptionInfo(apiClientSubscriptionInfo, modelClientSubscriptionInfo);</span>

<span class="fc" id="L549">                                Object existingUddiEntity = em.find(modelClientSubscriptionInfo.getClass(), modelClientSubscriptionInfo.getSubscriptionKey());</span>
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">                                if (existingUddiEntity != null) {</span>
<span class="nc" id="L551">                                        em.remove(existingUddiEntity);</span>
                                }

<span class="fc" id="L554">                                em.persist(modelClientSubscriptionInfo);</span>

<span class="fc" id="L556">                                result.getClientSubscriptionInfo().add(apiClientSubscriptionInfo);</span>
<span class="fc" id="L557">                        }</span>

<span class="fc" id="L559">                        tx.commit();</span>

<span class="fc" id="L561">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L562">                        serviceCounter.update(JUDDIQuery.SAVE_CLIENT_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L564">                        return result;</span>
<span class="nc" id="L565">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L566">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L567">                        serviceCounter.update(JUDDIQuery.SAVE_CLIENT_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L569">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L572" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L573">                                tx.rollback();</span>
                        }
<span class="pc" id="L575">                        em.close();</span>
                }
        }

        /**
         * Gets all client subscription information. This is used for server to
         * server subscriptions Administrative privilege required.
         *
         * @param body
         * @return ClientSubscriptionInfoDetail
         * @throws DispositionReportFaultMessage
         */
        @SuppressWarnings(&quot;unchecked&quot;)
        public ClientSubscriptionInfoDetail getAllClientSubscriptionInfoDetail(GetAllClientSubscriptionInfoDetail body)
                throws DispositionReportFaultMessage {
<span class="nc" id="L590">                long startTime = System.currentTimeMillis();</span>
<span class="nc" id="L591">                new ValidateClientSubscriptionInfo(null).validateGetAllClientSubscriptionDetail(body);</span>

<span class="nc" id="L593">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L594">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L596">                        tx.begin();</span>

<span class="nc" id="L598">                        this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="nc" id="L600">                        ClientSubscriptionInfoDetail result = new ClientSubscriptionInfoDetail();</span>

<span class="nc" id="L602">                        Query query = em.createQuery(&quot;SELECT cs from ClientSubscriptionInfo as cs&quot;);</span>
<span class="nc" id="L603">                        List&lt;org.apache.juddi.model.ClientSubscriptionInfo&gt; modelClientSubscriptionInfoList = query.getResultList();</span>

<span class="nc bnc" id="L605" title="All 2 branches missed.">                        for (ClientSubscriptionInfo modelClientSubscriptionInfo : modelClientSubscriptionInfoList) {</span>

<span class="nc" id="L607">                                org.apache.juddi.api_v3.ClientSubscriptionInfo apiClientSubscriptionInfo = new org.apache.juddi.api_v3.ClientSubscriptionInfo();</span>

<span class="nc" id="L609">                                MappingModelToApi.mapClientSubscriptionInfo(modelClientSubscriptionInfo, apiClientSubscriptionInfo, em);</span>

<span class="nc" id="L611">                                result.getClientSubscriptionInfo().add(apiClientSubscriptionInfo);</span>
<span class="nc" id="L612">                        }</span>

<span class="nc" id="L614">                        tx.commit();</span>
<span class="nc" id="L615">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L616">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLIENT_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L618">                        return result;</span>
<span class="nc" id="L619">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L620">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L621">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLIENT_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L623">                        throw drfm;</span>

                } finally {
<span class="nc bnc" id="L626" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L627">                                tx.rollback();</span>
                        }
<span class="nc" id="L629">                        em.close();</span>
                }

        }

        /**
         * Retrieves clientSubscriptionKey(s) from the persistence layer. This
         * method is specific to jUDDI. Used for server to server subscriptions
         * Administrative privilege required.
         *
         * @param body
         * @return ClientSubscriptionInfoDetail
         * @throws DispositionReportFaultMessage
         */
        public ClientSubscriptionInfoDetail getClientSubscriptionInfoDetail(GetClientSubscriptionInfoDetail body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L645">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L646">                new ValidateClientSubscriptionInfo(null).validateGetClientSubscriptionInfoDetail(body);</span>

<span class="fc" id="L648">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L649">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L651">                        tx.begin();</span>

<span class="fc" id="L653">                        this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L655">                        ClientSubscriptionInfoDetail result = new ClientSubscriptionInfoDetail();</span>

<span class="fc" id="L657">                        List&lt;String&gt; subscriptionKeyList = body.getClientSubscriptionKey();</span>
<span class="fc bfc" id="L658" title="All 2 branches covered.">                        for (String subscriptionKey : subscriptionKeyList) {</span>

<span class="fc" id="L660">                                org.apache.juddi.model.ClientSubscriptionInfo modelClientSubscriptionInfo = null;</span>

                                try {
<span class="fc" id="L663">                                        modelClientSubscriptionInfo = em.find(org.apache.juddi.model.ClientSubscriptionInfo.class, subscriptionKey);</span>
<span class="nc" id="L664">                                } catch (ClassCastException e) {</span>
<span class="fc" id="L665">                                }</span>
<span class="fc bfc" id="L666" title="All 2 branches covered.">                                if (modelClientSubscriptionInfo == null) {</span>
<span class="fc" id="L667">                                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.invalidkey.SubscripKeyNotFound&quot;, subscriptionKey));</span>
                                }

<span class="fc" id="L670">                                org.apache.juddi.api_v3.ClientSubscriptionInfo apiClientSubscriptionInfo = new org.apache.juddi.api_v3.ClientSubscriptionInfo();</span>

<span class="fc" id="L672">                                MappingModelToApi.mapClientSubscriptionInfo(modelClientSubscriptionInfo, apiClientSubscriptionInfo, em);</span>

<span class="fc" id="L674">                                result.getClientSubscriptionInfo().add(apiClientSubscriptionInfo);</span>
<span class="fc" id="L675">                        }</span>

<span class="fc" id="L677">                        tx.commit();</span>

<span class="fc" id="L679">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L680">                        serviceCounter.update(JUDDIQuery.GET_CLIENT_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L682">                        return result;</span>
<span class="fc" id="L683">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="fc" id="L684">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L685">                        serviceCounter.update(JUDDIQuery.GET_CLIENT_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="fc" id="L687">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L689" title="2 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="pc" id="L690">                                tx.rollback();</span>
                        }
<span class="fc" id="L692">                        em.close();</span>
                }

        }

        /**
         * Saves clerk(s) to the persistence layer. This method is specific to
         * jUDDI. This is used for server to server subscriptions and for future
         * use with replication. Administrative privilege required.
         *
         * @param body
         * @return ClerkDetail
         * @throws DispositionReportFaultMessage
         */
        @Override
        public ClerkDetail saveClerk(SaveClerk body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L709">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L710">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L711">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L713">                        tx.begin();</span>

<span class="fc" id="L715">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L717">                        new ValidateClerk(publisher).validateSaveClerk(em, body);</span>

<span class="fc" id="L719">                        ClerkDetail result = new ClerkDetail();</span>

<span class="fc" id="L721">                        List&lt;org.apache.juddi.api_v3.Clerk&gt; apiClerkList = body.getClerk();;</span>
<span class="fc bfc" id="L722" title="All 2 branches covered.">                        for (org.apache.juddi.api_v3.Clerk apiClerk : apiClerkList) {</span>

<span class="fc" id="L724">                                org.apache.juddi.model.Clerk modelClerk = new org.apache.juddi.model.Clerk();</span>

<span class="fc" id="L726">                                MappingApiToModel.mapClerk(apiClerk, modelClerk);</span>
<span class="fc" id="L727">                                org.apache.juddi.model.Node node2 = em.find(org.apache.juddi.model.Node.class, apiClerk.getNode().getName());</span>
<span class="fc bfc" id="L728" title="All 2 branches covered.">                                if (node2 == null) {</span>
                                        //it doesn't exist yet
<span class="fc" id="L730">                                        node2 = new Node();</span>
<span class="fc" id="L731">                                        MappingApiToModel.mapNode(apiClerk.getNode(), node2);</span>
<span class="fc" id="L732">                                        em.persist(node2);</span>
                                }

<span class="fc" id="L735">                                modelClerk.setNode(node2.getName());</span>
<span class="fc" id="L736">                                Object existingUddiEntity = em.find(modelClerk.getClass(), modelClerk.getClerkName());</span>
<span class="pc bpc" id="L737" title="1 of 2 branches missed.">                                if (existingUddiEntity != null) {</span>

<span class="nc" id="L739">                                        em.merge(modelClerk);</span>
                                } else {
<span class="fc" id="L741">                                        em.persist(modelClerk);</span>
                                }

<span class="fc" id="L744">                                result.getClerk().add(apiClerk);</span>
<span class="fc" id="L745">                        }</span>

<span class="fc" id="L747">                        tx.commit();</span>
<span class="fc" id="L748">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L749">                        serviceCounter.update(JUDDIQuery.SAVE_CLERK,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L751">                        return result;</span>
<span class="nc" id="L752">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L753">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L754">                        serviceCounter.update(JUDDIQuery.SAVE_CLERK,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L756">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L759" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L760">                                tx.rollback();</span>
                        }
<span class="pc" id="L762">                        em.close();</span>
                }
        }

        /**
         * Saves nodes(s) to the persistence layer. This method is specific to
         * jUDDI. Administrative privilege required. This is used for server to
         * server subscriptions and for future use with replication.
         * Administrative privilege required.
         *
         * @param body
         * @return NodeDetail
         * @throws DispositionReportFaultMessage
         */
        public NodeDetail saveNode(SaveNode body)
                throws DispositionReportFaultMessage {
<span class="fc" id="L778">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L779">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L780">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L782">                        tx.begin();</span>

<span class="fc" id="L784">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, body.getAuthInfo());</span>

<span class="fc" id="L786">                        new ValidateNode(publisher).validateSaveNode(em, body);</span>

<span class="fc" id="L788">                        NodeDetail result = new NodeDetail();</span>

<span class="fc" id="L790">                        List&lt;org.apache.juddi.api_v3.Node&gt; apiNodeList = body.getNode();</span>
<span class="fc bfc" id="L791" title="All 2 branches covered.">                        for (org.apache.juddi.api_v3.Node apiNode : apiNodeList) {</span>

<span class="fc" id="L793">                                org.apache.juddi.model.Node modelNode = new org.apache.juddi.model.Node();</span>

<span class="fc" id="L795">                                MappingApiToModel.mapNode(apiNode, modelNode);</span>

<span class="fc" id="L797">                                Object existingUddiEntity = em.find(modelNode.getClass(), modelNode.getName());</span>
<span class="pc bpc" id="L798" title="1 of 2 branches missed.">                                if (existingUddiEntity != null) {</span>
<span class="nc" id="L799">                                        em.merge(modelNode);</span>
                                } else {
<span class="fc" id="L801">                                        em.persist(modelNode);</span>
                                }

<span class="fc" id="L804">                                result.getNode().add(apiNode);</span>
<span class="fc" id="L805">                        }</span>

<span class="fc" id="L807">                        tx.commit();</span>
<span class="fc" id="L808">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L809">                        serviceCounter.update(JUDDIQuery.SAVE_NODE,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L811">                        return result;</span>
<span class="fc" id="L812">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="fc" id="L813">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L814">                        serviceCounter.update(JUDDIQuery.SAVE_NODE,</span>
                                QueryStatus.FAILED, procTime);
<span class="fc" id="L816">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L819" title="2 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="pc" id="L820">                                tx.rollback();</span>
                        }
<span class="fc" id="L822">                        em.close();</span>
                }
        }

        /**
         * Instructs the registry to perform a synchronous subscription
         * response.
         *
         * @param body
         * @return SyncSubscriptionDetail
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public SyncSubscriptionDetail invokeSyncSubscription(
                SyncSubscription body) throws DispositionReportFaultMessage,
                RemoteException {
<span class="nc" id="L840">                long startTime = System.currentTimeMillis();</span>
                //validate
<span class="nc" id="L842">                SyncSubscriptionDetail syncSubscriptionDetail = new SyncSubscriptionDetail();</span>

<span class="nc" id="L844">                Map&lt;String, org.apache.juddi.api_v3.ClientSubscriptionInfo&gt; clientSubscriptionInfoMap</span>
                        = new HashMap&lt;String, org.apache.juddi.api_v3.ClientSubscriptionInfo&gt;();
                //find the clerks to go with these subscriptions
<span class="nc" id="L847">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L848">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L850">                        tx.begin();</span>

<span class="nc" id="L852">                        this.getEntityPublisher(em, body.getAuthInfo());</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                        for (GetSubscriptionResults getSubscriptionResult : body.getGetSubscriptionResultsList()) {</span>
<span class="nc" id="L854">                                String subscriptionKey = getSubscriptionResult.getSubscriptionKey();</span>
<span class="nc" id="L855">                                org.apache.juddi.model.ClientSubscriptionInfo modelClientSubscriptionInfo = null;</span>

                                try {
<span class="nc" id="L858">                                        modelClientSubscriptionInfo = em.find(org.apache.juddi.model.ClientSubscriptionInfo.class, subscriptionKey);</span>
<span class="nc" id="L859">                                } catch (ClassCastException e) {</span>
<span class="nc" id="L860">                                }</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">                                if (modelClientSubscriptionInfo == null) {</span>
<span class="nc" id="L862">                                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.invalidkey.SubscripKeyNotFound&quot;, subscriptionKey));</span>
                                }
<span class="nc" id="L864">                                org.apache.juddi.api_v3.ClientSubscriptionInfo apiClientSubscriptionInfo = new org.apache.juddi.api_v3.ClientSubscriptionInfo();</span>
<span class="nc" id="L865">                                MappingModelToApi.mapClientSubscriptionInfo(modelClientSubscriptionInfo, apiClientSubscriptionInfo, em);</span>
<span class="nc" id="L866">                                clientSubscriptionInfoMap.put(apiClientSubscriptionInfo.getSubscriptionKey(), apiClientSubscriptionInfo);</span>
<span class="nc" id="L867">                        }</span>

<span class="nc" id="L869">                        tx.commit();</span>
<span class="nc" id="L870">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L871">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L872">                        serviceCounter.update(JUDDIQuery.INVOKE_SYNCSUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L874">                        throw drfm;</span>

                } finally {
<span class="nc bnc" id="L877" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L878">                                tx.rollback();</span>
                        }
<span class="nc" id="L880">                        em.close();</span>
<span class="nc" id="L881">                }</span>

<span class="nc bnc" id="L883" title="All 2 branches missed.">                for (GetSubscriptionResults getSubscriptionResult : body.getGetSubscriptionResultsList()) {</span>
                        try {
<span class="nc" id="L885">                                String subscriptionKey = getSubscriptionResult.getSubscriptionKey();</span>
<span class="nc" id="L886">                                Clerk fromClerk = clientSubscriptionInfoMap.get(subscriptionKey).getFromClerk();</span>
<span class="nc" id="L887">                                Clerk toClerk = clientSubscriptionInfoMap.get(subscriptionKey).getToClerk();</span>
<span class="nc" id="L888">                                String clazz = fromClerk.getNode().getProxyTransport();</span>
<span class="nc" id="L889">                                Class&lt;?&gt; transportClass = ClassUtil.forName(clazz, this.getClass());</span>
<span class="nc" id="L890">                                Transport transport = (Transport) transportClass.getConstructor(String.class</span>
<span class="nc" id="L891">                                ).newInstance(fromClerk.getNode().getName());</span>
<span class="nc" id="L892">                                UDDISubscriptionPortType subscriptionService = transport.getUDDISubscriptionService(fromClerk.getNode().getSubscriptionUrl());</span>
<span class="nc" id="L893">                                SubscriptionResultsList list = subscriptionService.getSubscriptionResults(getSubscriptionResult);</span>

<span class="nc" id="L895">                                JAXBContext context = JAXBContext.newInstance(list.getClass());</span>
<span class="nc" id="L896">                                Marshaller marshaller = context.createMarshaller();</span>
<span class="nc" id="L897">                                StringWriter sw = new StringWriter();</span>

<span class="nc" id="L899">                                marshaller.marshal(list, sw);</span>

<span class="nc" id="L901">                                log.info(</span>
<span class="nc" id="L902">                                        &quot;Notification received by UDDISubscriptionListenerService : &quot; + sw.toString());</span>

<span class="nc" id="L904">                                NotificationList&lt;String&gt; nl = NotificationList.getInstance();</span>

<span class="nc" id="L906">                                nl.getNotifications()</span>
<span class="nc" id="L907">                                        .add(sw.toString());</span>

                                //update the registry with the notification list.
<span class="nc" id="L910">                                XRegisterHelper.handle(fromClerk, toClerk, list);</span>

<span class="nc" id="L912">                                syncSubscriptionDetail.getSubscriptionResultsList()</span>
<span class="nc" id="L913">                                        .add(list);</span>
<span class="nc" id="L914">                        } catch (Exception ce) {</span>
<span class="nc" id="L915">                                log.error(ce.getMessage(), ce);</span>
<span class="nc" id="L916">                                long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L917">                                serviceCounter.update(JUDDIQuery.SAVE_NODE,</span>
                                        QueryStatus.FAILED, procTime);
<span class="nc bnc" id="L919" title="All 2 branches missed.">                                if (ce instanceof DispositionReportFaultMessage) {</span>
<span class="nc" id="L920">                                        throw (DispositionReportFaultMessage) ce;</span>
                                }
<span class="nc bnc" id="L922" title="All 2 branches missed.">                                if (ce instanceof RemoteException) {</span>
<span class="nc" id="L923">                                        DispositionReportFaultMessage x = new FatalErrorException(new ErrorMessage(&quot;errors.subscriptionnotifier.client&quot;, ce.getMessage()));</span>
<span class="nc" id="L924">                                        throw x;</span>
                                }
<span class="nc" id="L926">                        }</span>
<span class="nc" id="L927">                }</span>
                //for now sending a clean object back

<span class="nc" id="L930">                long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L931">                serviceCounter.update(JUDDIQuery.INVOKE_SYNCSUB,</span>
                        QueryStatus.SUCCESS, procTime);
<span class="nc" id="L933">                return syncSubscriptionDetail;</span>
        }

        @Override
        public NodeList getAllNodes(String authInfo) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L938">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L939">                NodeList r = new NodeList();</span>

<span class="fc" id="L941">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L942">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L944">                        tx.begin();</span>

<span class="fc" id="L946">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, authInfo);</span>

<span class="fc" id="L948">                        new ValidatePublish(publisher).validateGetAllNodes();</span>

<span class="fc" id="L950">                        StringBuilder sql = new StringBuilder();</span>
<span class="fc" id="L951">                        sql.append(&quot;select distinct c from Node c &quot;);</span>
<span class="fc" id="L952">                        sql.toString();</span>
<span class="fc" id="L953">                        Query qry = em.createQuery(sql.toString());</span>
<span class="fc" id="L954">                        List&lt;org.apache.juddi.model.Node&gt; resultList = qry.getResultList();</span>
<span class="fc bfc" id="L955" title="All 2 branches covered.">                        for (int i = 0; i &lt; resultList.size(); i++) {</span>
<span class="fc" id="L956">                                org.apache.juddi.api_v3.Node api = new org.apache.juddi.api_v3.Node();</span>
<span class="fc" id="L957">                                MappingModelToApi.mapNode(resultList.get(i), api);</span>
<span class="fc" id="L958">                                r.getNode().add(api);</span>

                        }

<span class="fc" id="L962">                        tx.commit();</span>
<span class="fc" id="L963">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L964">                        serviceCounter.update(JUDDIQuery.GET_ALL_NODES,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L966">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L967">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L968">                        serviceCounter.update(JUDDIQuery.GET_ALL_NODES,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L970">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L972" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L973">                                tx.rollback();</span>
                        }
<span class="pc" id="L975">                        em.close();</span>
<span class="fc" id="L976">                }</span>

<span class="fc" id="L978">                return r;</span>
        }

        @Override
        public ClerkList getAllClerks(String authInfo) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L983">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L984">                ClerkList ret = new ClerkList();</span>
<span class="fc" id="L985">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L986">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L988">                        tx.begin();</span>

<span class="fc" id="L990">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, authInfo);</span>

<span class="fc" id="L992">                        new ValidatePublish(publisher).validateGetAllNodes();</span>

<span class="fc" id="L994">                        StringBuilder sql = new StringBuilder();</span>
<span class="fc" id="L995">                        sql.append(&quot;select distinct c from Clerk c &quot;);</span>
<span class="fc" id="L996">                        sql.toString();</span>
<span class="fc" id="L997">                        Query qry = em.createQuery(sql.toString());</span>
<span class="fc" id="L998">                        List&lt;org.apache.juddi.model.Clerk&gt; resultList = qry.getResultList();</span>
<span class="fc bfc" id="L999" title="All 2 branches covered.">                        for (int i = 0; i &lt; resultList.size(); i++) {</span>
<span class="fc" id="L1000">                                Clerk api = new Clerk();</span>
<span class="fc" id="L1001">                                MappingModelToApi.mapClerk(resultList.get(i), api, em);</span>
<span class="fc" id="L1002">                                ret.getClerk().add(api);</span>

                        }
<span class="fc" id="L1005">                        tx.commit();</span>
<span class="fc" id="L1006">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1007">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLERKS,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1009">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1010">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1011">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLERKS,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1013">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1016" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1017">                                tx.rollback();</span>
                        }
<span class="pc" id="L1019">                        em.close();</span>
<span class="fc" id="L1020">                }</span>

<span class="fc" id="L1022">                return ret;</span>

        }

        @Override
        public void deleteNode(DeleteNode req) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1028">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L1029">                boolean found = false;</span>
<span class="fc" id="L1030">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1031">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1033">                        tx.begin();</span>
                        //TODO if the given node is in the replication config, prevent deletion
<span class="fc" id="L1035">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, req.getAuthInfo());</span>
<span class="fc" id="L1036">                        new ValidatePublish(publisher).validateDeleteNode(em, req, getReplicationNodes(req.getAuthInfo()));</span>

<span class="fc" id="L1038">                        org.apache.juddi.model.Node existingUddiEntity = em.find(org.apache.juddi.model.Node.class, req.getNodeID());</span>
<span class="pc bpc" id="L1039" title="1 of 2 branches missed.">                        if (existingUddiEntity != null) {</span>

                                //cascade delete all clerks tied to this node, confirm that it works
<span class="fc" id="L1042">                                Query createQuery = em.createQuery(&quot;delete from Clerk c where c.node = :nodename&quot;);</span>
<span class="fc" id="L1043">                                createQuery.setParameter(&quot;nodename&quot;, req.getNodeID());</span>
<span class="fc" id="L1044">                                createQuery.executeUpdate();</span>

<span class="fc" id="L1046">                                em.remove(existingUddiEntity);</span>
<span class="fc" id="L1047">                                found = true;</span>
<span class="fc" id="L1048">                        } else {</span>
<span class="nc" id="L1049">                                throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.deleteNode.NotFound&quot;));</span>
                        }

<span class="fc" id="L1052">                        tx.commit();</span>
<span class="fc" id="L1053">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1054">                        serviceCounter.update(JUDDIQuery.DELETE_NODE,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1056">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1057">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1058">                        serviceCounter.update(JUDDIQuery.DELETE_NODE,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1060">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1063" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1064">                                tx.rollback();</span>
                        }
<span class="pc" id="L1066">                        em.close();</span>
<span class="fc" id="L1067">                }</span>

<span class="pc bpc" id="L1069" title="1 of 2 branches missed.">                if (!found) {</span>

<span class="nc" id="L1071">                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.deleteNode.NotFound&quot;, req.getNodeID()));</span>
                }
<span class="fc" id="L1073">        }</span>

        @Override
        public void deleteClerk(DeleteClerk req) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1077">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L1078">                boolean found = false;</span>
<span class="fc" id="L1079">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1080">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1082">                        tx.begin();</span>

<span class="fc" id="L1084">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, req.getAuthInfo());</span>

<span class="fc" id="L1086">                        new ValidatePublish(publisher).validateDeleteClerk(em, req);</span>

<span class="fc" id="L1088">                        org.apache.juddi.model.Clerk existingUddiEntity = em.find(org.apache.juddi.model.Clerk.class, req.getClerkID());</span>
<span class="pc bpc" id="L1089" title="1 of 2 branches missed.">                        if (existingUddiEntity</span>
                                != null) {
<span class="fc" id="L1091">                                em.remove(existingUddiEntity);</span>
<span class="fc" id="L1092">                                found = true;</span>
                        }

<span class="fc" id="L1095">                        tx.commit();</span>
<span class="fc" id="L1096">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1097">                        serviceCounter.update(JUDDIQuery.DELETE_CLERK,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1099">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1100">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1101">                        serviceCounter.update(JUDDIQuery.DELETE_CLERK,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1103">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1106" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1107">                                tx.rollback();</span>
                        }
<span class="pc" id="L1109">                        em.close();</span>
<span class="fc" id="L1110">                }</span>

<span class="pc bpc" id="L1112" title="1 of 2 branches missed.">                if (!found) {</span>
<span class="nc" id="L1113">                        throw new InvalidKeyPassedException(new ErrorMessage(&quot;errors.deleteClerk.NotFound&quot;));</span>
                }

<span class="fc" id="L1116">        }</span>

        /*
         * enables tmodel owners to setup valid values for tmodel instance infos
         * to use?
         *
         * @param authInfo
         * @param values
         * @return
         * @throws DispositionReportFaultMessage
         
         @Override
         public DispositionReport setAllValidValues(String authInfo, List&lt;ValidValues&gt; values) throws DispositionReportFaultMessage, RemoteException {
         throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.
         /*  EntityManager em = PersistenceManager.getEntityManager();
         UddiEntityPublisher entityPublisher = getEntityPublisher(em, authInfo);

         new ValidateValueSetValidation(entityPublisher).validateSetAllValidValues(values);

         EntityTransaction tx = em.getTransaction();
         try {

         // is this tModel used anywhere?, if so, validate all instances against the new rule?
         tx.begin();

         //each tmodel/value set
         for (int i = 0; i &lt; values.size(); i++) {
         //remove any existing references to the key
         ValueSetValues find = em.find(ValueSetValues.class, values.get(i).getTModekKey());

         if (find != null) {
         find.setValidatorClass(values.get(i).getValidationClass());
         em.persist(find);

         } else {
         org.apache.juddi.model.ValueSetValues vv = new ValueSetValues();
         vv.setTModelKey(values.get(i).getTModekKey());
         vv.setValidatorClass(values.get(i).getValidationClass());
         em.persist(vv);
         }
         }

         tx.commit();
         } finally {
         if (tx.isActive()) {
         tx.rollback();
         }
         em.close();
         }
         DispositionReport r = new DispositionReport();
         r.getResult().add(new Result());
         return r;
         }*/
        @Override
        public void adminDeleteSubscription(String authInfo, List&lt;String&gt; subscriptionKey) throws DispositionReportFaultMessage, RemoteException {

<span class="nc" id="L1172">                long startTime = System.currentTimeMillis();</span>

<span class="nc" id="L1174">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L1175">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L1177">                        tx.begin();</span>

<span class="nc" id="L1179">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, authInfo);</span>
<span class="nc bnc" id="L1180" title="All 2 branches missed.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="nc" id="L1181">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }
                        //new ValidateSubscription(publisher).validateDeleteSubscription(em, body);
<span class="nc" id="L1184">                        List&lt;TemporaryMailContainer&gt; notifications = new ArrayList&lt;TemporaryMailContainer&gt;();</span>
<span class="nc" id="L1185">                        List&lt;String&gt; subscriptionKeyList = subscriptionKey;</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">                        for (String key : subscriptionKeyList) {</span>
<span class="nc bnc" id="L1187" title="All 4 branches missed.">                                if (key != null &amp;&amp; key.length() &gt; 0) {</span>
<span class="nc" id="L1188">                                        org.apache.juddi.model.Subscription obj = em.find(org.apache.juddi.model.Subscription.class, key);</span>
<span class="nc" id="L1189">                                        Publisher publisher = em.find(Publisher.class, obj.getAuthorizedName());</span>
<span class="nc" id="L1190">                                        notifications.add(new TemporaryMailContainer(obj, publisher, (Publisher) requestor));</span>
<span class="nc" id="L1191">                                        em.remove(obj);</span>
                                }
<span class="nc" id="L1193">                        }</span>

<span class="nc" id="L1195">                        tx.commit();</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">                        for (TemporaryMailContainer t : notifications) {</span>
<span class="nc" id="L1197">                                USERFRIENDLYSMTPNotifier.notifySubscriptionDeleted(t);</span>
<span class="nc" id="L1198">                        }</span>
<span class="nc" id="L1199">                        notifications.clear();</span>
<span class="nc" id="L1200">                        notifications = null;</span>
<span class="nc" id="L1201">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1202">                        serviceCounter.update(JUDDIQuery.ADMIN_DELETE_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1204">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1205">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1206">                        serviceCounter.update(JUDDIQuery.ADMIN_DELETE_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1208">                        throw drfm;</span>
                } finally {
<span class="nc bnc" id="L1210" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1211">                                tx.rollback();</span>
                        }
<span class="nc" id="L1213">                        em.close();</span>
<span class="nc" id="L1214">                }</span>

<span class="nc" id="L1216">        }</span>

        @Override
        public DispositionReport adminSaveBusiness(String authInfo, List&lt;AdminSaveBusinessWrapper&gt; values) throws DispositionReportFaultMessage, RemoteException {
<span class="nc" id="L1220">                long startTime = System.currentTimeMillis();</span>
<span class="nc" id="L1221">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L1222">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L1224">                        tx.begin();</span>
<span class="nc" id="L1225">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, authInfo);</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="nc" id="L1227">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }

<span class="nc bnc" id="L1230" title="All 2 branches missed.">                        for (int i = 0; i &lt; values.size(); i++) {</span>
                                //impersonate the user
<span class="nc" id="L1232">                                AuthToken authToken = sec.getAuthToken(values.get(i).getPublisherID());</span>

<span class="nc" id="L1234">                                SaveBusiness stm = new SaveBusiness();</span>

<span class="nc" id="L1236">                                stm.setAuthInfo(authToken.getAuthInfo());</span>
<span class="nc" id="L1237">                                stm.getBusinessEntity().addAll(values.get(i).getBusinessEntity());</span>
<span class="nc" id="L1238">                                pub.saveBusiness(stm);</span>
                        }

<span class="nc" id="L1241">                        tx.commit();</span>
<span class="nc" id="L1242">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1243">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_BUSINESS,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1245">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1246">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1247">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_BUSINESS,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1249">                        throw drfm;</span>

                } finally {
<span class="nc bnc" id="L1252" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1253">                                tx.rollback();</span>
                        }
<span class="nc" id="L1255">                        em.close();</span>
<span class="nc" id="L1256">                }</span>

<span class="nc" id="L1258">                DispositionReport r = new DispositionReport();</span>
<span class="nc" id="L1259">                return r;</span>

        }

        @Override
        public DispositionReport adminSaveTModel(String authInfo, List&lt;AdminSaveTModelWrapper&gt; values) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1265">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L1266">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1267">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1269">                        tx.begin();</span>
<span class="fc" id="L1270">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, authInfo);</span>
<span class="pc bpc" id="L1271" title="1 of 2 branches missed.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="nc" id="L1272">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }

<span class="pc bpc" id="L1275" title="1 of 2 branches missed.">                        for (int i = 0; i &lt; values.size(); i++) {</span>
                                //impersonate the user
<span class="nc" id="L1277">                                AuthToken authToken = sec.getAuthToken(values.get(i).getPublisherID());</span>
<span class="nc" id="L1278">                                SaveTModel stm = new SaveTModel();</span>
<span class="nc" id="L1279">                                stm.setAuthInfo(authToken.getAuthInfo());</span>
<span class="nc" id="L1280">                                stm.getTModel().addAll(values.get(i).getTModel());</span>
<span class="nc" id="L1281">                                pub.saveTModel(stm);</span>
                        }
<span class="fc" id="L1283">                        tx.commit();</span>
<span class="fc" id="L1284">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1285">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_TMODEL,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1287">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1288">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1289">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_TMODEL,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1291">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1294" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1295">                                tx.rollback();</span>
                        }
<span class="pc" id="L1297">                        em.close();</span>
<span class="fc" id="L1298">                }</span>

<span class="fc" id="L1300">                DispositionReport r = new DispositionReport();</span>
<span class="fc" id="L1301">                return r;</span>
        }

        @Override
        public List&lt;SubscriptionWrapper&gt; getAllClientSubscriptionInfo(String authInfo) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1306">                long startTime = System.currentTimeMillis();</span>

<span class="fc" id="L1308">                List&lt;SubscriptionWrapper&gt; r = new ArrayList&lt;SubscriptionWrapper&gt;();</span>

<span class="fc" id="L1310">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1311">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1313">                        tx.begin();</span>

<span class="fc" id="L1315">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, authInfo);</span>
<span class="pc bpc" id="L1316" title="1 of 2 branches missed.">                        if (!((Publisher) publisher).isAdmin()) {</span>
<span class="nc" id="L1317">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }

<span class="fc" id="L1320">                        StringBuilder sql = new StringBuilder();</span>
<span class="fc" id="L1321">                        sql.append(&quot;select distinct c from Subscription c &quot;);</span>
<span class="fc" id="L1322">                        Query qry = em.createQuery(sql.toString());</span>
<span class="fc" id="L1323">                        List&lt;org.apache.juddi.model.Subscription&gt; resultList = qry.getResultList();</span>
<span class="pc bpc" id="L1324" title="1 of 2 branches missed.">                        for (int i = 0; i &lt; resultList.size(); i++) {</span>
<span class="nc" id="L1325">                                Subscription sub = new Subscription();</span>
<span class="nc" id="L1326">                                MappingModelToApi.mapSubscription(resultList.get(i), sub);</span>
<span class="nc" id="L1327">                                SubscriptionWrapper x = new SubscriptionWrapper();</span>
<span class="nc" id="L1328">                                x.getSubscription().add(sub);</span>
<span class="nc" id="L1329">                                x.setPublisherIdOrUsername(resultList.get(i).getAuthorizedName());</span>
<span class="nc" id="L1330">                                r.add(x);</span>
                        }

<span class="fc" id="L1333">                        tx.commit();</span>
<span class="fc" id="L1334">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1335">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLIENT_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1337">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1338">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1339">                        serviceCounter.update(JUDDIQuery.GET_ALL_CLIENT_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1341">                        throw drfm;</span>
                } finally {
<span class="pc bpc" id="L1343" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1344">                                tx.rollback();</span>
                        }
<span class="pc" id="L1346">                        em.close();</span>
<span class="fc" id="L1347">                }</span>

<span class="fc" id="L1349">                return r;</span>
        }

        @Override
        public synchronized DispositionReport setReplicationNodes(String authInfo, org.uddi.repl_v3.ReplicationConfiguration replicationConfiguration) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1354">                long startTime = System.currentTimeMillis();</span>

<span class="fc" id="L1356">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1357">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1359">                        tx.begin();</span>

<span class="fc" id="L1361">                        org.uddi.repl_v3.ReplicationConfiguration oldConfig = null;</span>
<span class="fc" id="L1362">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, authInfo);</span>
<span class="pc bpc" id="L1363" title="1 of 2 branches missed.">                        if (!((Publisher) publisher).isAdmin()) {</span>
<span class="nc" id="L1364">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }
<span class="fc" id="L1366">                        new ValidateReplication(publisher).validateSetReplicationNodes(replicationConfiguration, em, getNode(), AppConfig.getConfiguration());</span>

<span class="fc" id="L1368">                        org.apache.juddi.model.ReplicationConfiguration model = null;</span>
<span class="fc" id="L1369">                        logger.info(publisher.getAuthorizedName() + &quot; is setting the replication config from &quot; + getRequestorsIPAddress());// + &quot; &quot; + sw.toString());</span>
                        try {
<span class="fc" id="L1371">                                model = (ReplicationConfiguration) em.createQuery(&quot;select c FROM ReplicationConfiguration c order by c.serialNumber desc&quot;).getSingleResult();</span>
<span class="fc" id="L1372">                        } catch (Exception ex) {</span>
<span class="fc" id="L1373">                        }</span>
<span class="fc" id="L1374">                        SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyyMMddkkmmZ&quot;);</span>
<span class="fc bfc" id="L1375" title="All 2 branches covered.">                        if (model == null) {</span>
                                //this is a brand new configuration and we didn't have one before
<span class="fc" id="L1377">                                model = new ReplicationConfiguration();</span>
<span class="fc" id="L1378">                                MappingApiToModel.mapReplicationConfiguration(replicationConfiguration, model, em);</span>
<span class="fc" id="L1379">                                model.setSerialNumber(System.currentTimeMillis());</span>
<span class="fc" id="L1380">                                model.setTimeOfConfigurationUpdate(sdf.format(new Date()));</span>
<span class="fc" id="L1381">                                em.persist(model);</span>
                                //if (newReplicationNode(model)){
                                //tell the replication notifier to start transfering with
                                //the first change record
                                //}

                        } else {
                                //a config exists, remove it, add the new one
                                //spec doesn't appear to mention if recording a change history on the config is required
                                //assuming we'll keep it for now, might be useful later.
                                //em.remove(model);
<span class="fc" id="L1392">                                oldConfig = new org.uddi.repl_v3.ReplicationConfiguration();</span>
<span class="fc" id="L1393">                                MappingModelToApi.mapReplicationConfiguration(model, oldConfig);</span>

<span class="fc" id="L1395">                                ReplicationConfiguration model2 = new ReplicationConfiguration();</span>
<span class="fc" id="L1396">                                MappingApiToModel.mapReplicationConfiguration(replicationConfiguration, model2, em);</span>
<span class="fc" id="L1397">                                model2.setSerialNumber(System.currentTimeMillis());</span>

<span class="fc" id="L1399">                                model2.setTimeOfConfigurationUpdate(sdf.format(new Date()));</span>
<span class="fc" id="L1400">                                em.persist(model2);</span>

                        }

<span class="fc" id="L1404">                        tx.commit();</span>
<span class="fc" id="L1405">                        UDDIReplicationImpl.notifyConfigurationChange(oldConfig, replicationConfiguration, this);</span>
<span class="fc" id="L1406">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1407">                        serviceCounter.update(JUDDIQuery.SET_REPLICATION_NODES,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1409">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1410">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1411">                        serviceCounter.update(JUDDIQuery.SET_REPLICATION_NODES,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1413">                        throw drfm;</span>
<span class="nc" id="L1414">                } catch (Exception ex) {</span>
<span class="nc" id="L1415">                        logger.error(ex, ex);</span>
<span class="nc" id="L1416">                        throw new FatalErrorException(new ErrorMessage(&quot;E_fatalError&quot;, ex.getMessage()));</span>
                } finally {
<span class="pc bpc" id="L1418" title="3 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1419">                                tx.rollback();</span>
                        }
<span class="pc" id="L1421">                        em.close();</span>
<span class="fc" id="L1422">                }</span>
<span class="fc" id="L1423">                DispositionReport d = new DispositionReport();</span>
<span class="fc" id="L1424">                Result res = new Result();</span>

<span class="fc" id="L1426">                d.getResult().add(res);</span>
<span class="fc" id="L1427">                return d;</span>
        }

        @Override
        public synchronized org.uddi.repl_v3.ReplicationConfiguration getReplicationNodes(String authInfo) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1432">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L1433">                org.uddi.repl_v3.ReplicationConfiguration r = new org.uddi.repl_v3.ReplicationConfiguration();</span>

<span class="fc" id="L1435">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1436">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1438">                        tx.begin();</span>

<span class="fc" id="L1440">                        UddiEntityPublisher publisher = this.getEntityPublisher(em, authInfo);</span>
<span class="pc bpc" id="L1441" title="1 of 2 branches missed.">                        if (!((Publisher) publisher).isAdmin()) {</span>
<span class="nc" id="L1442">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }

<span class="fc" id="L1445">                        StringBuilder sql = new StringBuilder();</span>
<span class="fc" id="L1446">                        sql.append(&quot;select c from ReplicationConfiguration c order by c.serialNumber desc&quot;);</span>
                        //sql.toString();
<span class="fc" id="L1448">                        Query qry = em.createQuery(sql.toString());</span>
<span class="fc" id="L1449">                        qry.setMaxResults(1);</span>

<span class="fc" id="L1451">                        org.apache.juddi.model.ReplicationConfiguration resultList = (org.apache.juddi.model.ReplicationConfiguration) qry.getSingleResult();</span>
<span class="fc" id="L1452">                        MappingModelToApi.mapReplicationConfiguration(resultList, r);</span>
<span class="fc" id="L1453">                        tx.commit();</span>
<span class="fc" id="L1454">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1455">                        serviceCounter.update(JUDDIQuery.GET_ALL_NODES,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1457">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1458">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1459">                        serviceCounter.update(JUDDIQuery.GET_ALL_NODES,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1461">                        throw drfm;</span>
<span class="nc" id="L1462">                } catch (Exception ex) {</span>
                        //possible that there is no config to return
<span class="nc" id="L1464">                        logger.debug(&quot;Error caught, is there a replication config is avaiable? Returning a default config (no replication): &quot;, ex);</span>

<span class="nc" id="L1466">                        r.setCommunicationGraph(new CommunicationGraph());</span>
<span class="nc" id="L1467">                        Operator op = new Operator();</span>
<span class="nc" id="L1468">                        op.setOperatorNodeID(getNode());</span>
<span class="nc" id="L1469">                        op.setSoapReplicationURL(baseUrlSSL + &quot;replication/services/replication&quot;);</span>

<span class="nc" id="L1471">                        op.getContact().add(new Contact());</span>
<span class="nc" id="L1472">                        op.getContact().get(0).getPersonName().add(new PersonName(&quot;Unknown&quot;, null));</span>
<span class="nc" id="L1473">                        op.setOperatorStatus(OperatorStatusType.NORMAL);</span>

<span class="nc" id="L1475">                        r.getOperator().add(op);</span>
<span class="nc" id="L1476">                        r.getCommunicationGraph().getNode().add(getNode());</span>
<span class="nc" id="L1477">                        r.getCommunicationGraph().getControlledMessage().add(&quot;*&quot;);</span>
<span class="nc" id="L1478">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1479">                        r.setSerialNumber(0);</span>
<span class="nc" id="L1480">                        SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyyMMddkkmmZ&quot;);</span>
<span class="nc" id="L1481">                        r.setTimeOfConfigurationUpdate(sdf.format(new Date()));</span>
<span class="nc" id="L1482">                        r.setRegistryContact(new org.uddi.repl_v3.ReplicationConfiguration.RegistryContact());</span>
                        try {
                                // pull from root business
<span class="nc bnc" id="L1485" title="All 2 branches missed.">                                if (!tx.isActive()) {</span>
<span class="nc" id="L1486">                                        tx = em.getTransaction();</span>
                                }

<span class="nc" id="L1489">                                BusinessEntity rootbiz = em.find(BusinessEntity.class, AppConfig.getConfiguration().getString(Property.JUDDI_NODE_ROOT_BUSINESS));</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                                if (rootbiz != null) {</span>

<span class="nc bnc" id="L1492" title="All 2 branches missed.">                                        for (int i = 0; i &lt; rootbiz.getContacts().size(); i++) {</span>
<span class="nc" id="L1493">                                                Contact c = new Contact();</span>
<span class="nc" id="L1494">                                                MappingModelToApi.mapContact(rootbiz.getContacts().get(i), c);</span>
<span class="nc" id="L1495">                                                r.getRegistryContact().setContact(c);</span>
<span class="nc" id="L1496">                                                break;</span>
                                        }

                                }
<span class="nc" id="L1500">                                tx.rollback();</span>

<span class="nc" id="L1502">                        } catch (Exception ex1) {</span>
<span class="nc" id="L1503">                                logger.warn(&quot;unexpected error&quot;, ex1);</span>
<span class="nc" id="L1504">                        }</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">                        if (r.getRegistryContact().getContact() == null) {</span>
<span class="nc" id="L1506">                                r.getRegistryContact().setContact(new Contact());</span>
<span class="nc" id="L1507">                                r.getRegistryContact().getContact().getPersonName().add(new PersonName(&quot;Unknown&quot;, null));</span>
                        }
<span class="nc" id="L1509">                        serviceCounter.update(JUDDIQuery.GET_REPLICATION_NODES,</span>
                                QueryStatus.SUCCESS, procTime);

                } finally {
<span class="pc bpc" id="L1513" title="5 of 6 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1514">                                tx.rollback();</span>
                        }
<span class="pc" id="L1516">                        em.close();</span>
<span class="pc" id="L1517">                }</span>

<span class="fc" id="L1519">                r.setMaximumTimeToGetChanges(BigInteger.ONE);</span>
<span class="fc" id="L1520">                r.setMaximumTimeToSyncRegistry(BigInteger.ONE);</span>
                //StringWriter sw = new StringWriter();
                //JAXB.marshal(r, sw);
                //logger.info(&quot;dumping returned replication config &quot; + sw.toString());
<span class="fc" id="L1524">                return r;</span>
        }

<span class="fc" id="L1527">        static UDDISubscriptionImpl sub = new UDDISubscriptionImpl();</span>
<span class="fc" id="L1528">        static UDDISecurityImpl sec = new UDDISecurityImpl();</span>
<span class="fc" id="L1529">        static UDDIPublicationImpl pub = new UDDIPublicationImpl();</span>

        @Override
        public void adminSaveSubscription(String authInfo, String publisherOrUsername, Holder&lt;List&lt;Subscription&gt;&gt; subscriptions) throws DispositionReportFaultMessage {
<span class="fc" id="L1533">                long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L1534">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1535">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1537">                        tx.begin();</span>
<span class="fc" id="L1538">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, authInfo);</span>
<span class="fc bfc" id="L1539" title="All 2 branches covered.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="fc" id="L1540">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }
                        //impersonate the user
<span class="fc" id="L1543">                        AuthToken authToken = sec.getAuthToken(publisherOrUsername);</span>
<span class="fc" id="L1544">                        sub.saveSubscription(authToken.getAuthInfo(), subscriptions);</span>
<span class="fc" id="L1545">                        tx.commit();</span>
<span class="fc" id="L1546">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1547">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_SUB,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L1549">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="fc" id="L1550">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1551">                        serviceCounter.update(JUDDIQuery.ADMIN_SAVE_SUB,</span>
                                QueryStatus.FAILED, procTime);
<span class="fc" id="L1553">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1556" title="2 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="pc" id="L1557">                                tx.rollback();</span>
                        }
<span class="fc" id="L1559">                        em.close();</span>
<span class="fc" id="L1560">                }</span>

<span class="fc" id="L1562">        }</span>

        /**
         * {@inheritDoc }
         *
         * @param body
         * @return item history or null if not found
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        @Override
        public GetEntityHistoryMessageResponse getEntityHistory(GetEntityHistoryMessageRequest body) throws DispositionReportFaultMessage, RemoteException {
<span class="fc" id="L1574">                long startTime = System.currentTimeMillis();</span>
<span class="fc bfc" id="L1575" title="All 2 branches covered.">                if (body == null) {</span>
<span class="fc" id="L1576">                        throw new InvalidValueException(new ErrorMessage(&quot;errors.NullInput&quot;));</span>
                }
<span class="fc" id="L1578">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="fc" id="L1579">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="fc" id="L1581">                        tx.begin();</span>
<span class="fc" id="L1582">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, body.getAuthInfo());</span>
<span class="pc bpc" id="L1583" title="1 of 2 branches missed.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="nc" id="L1584">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }
<span class="pc bpc" id="L1586" title="1 of 2 branches missed.">                        if (body.getMaxRecords() &lt;= 0) {</span>
<span class="fc" id="L1587">                                body.setMaxRecords(20);</span>
                        }
<span class="pc bpc" id="L1589" title="1 of 2 branches missed.">                        if (body.getOffset() &lt; 0) {</span>
<span class="nc" id="L1590">                                body.setOffset(0);</span>
                        }
<span class="fc" id="L1592">                        Query createQuery = em.createQuery(&quot;select m from ChangeRecord m where m.entityKey = :key order by m.id DESC&quot;);</span>
<span class="fc" id="L1593">                        createQuery.setMaxResults((int) body.getMaxRecords());</span>
<span class="fc" id="L1594">                        createQuery.setParameter(&quot;key&quot;, body.getEntityKey());</span>
<span class="fc" id="L1595">                        createQuery.setFirstResult((int) body.getOffset());</span>
<span class="fc" id="L1596">                        List&lt;ChangeRecord&gt; resultList = createQuery.getResultList();</span>
<span class="fc" id="L1597">                        GetEntityHistoryMessageResponse res = new GetEntityHistoryMessageResponse();</span>
<span class="fc" id="L1598">                        res.setChangeRecords(new ChangeRecords());</span>
<span class="fc bfc" id="L1599" title="All 2 branches covered.">                        for (ChangeRecord cr : resultList) {</span>
<span class="fc" id="L1600">                                res.getChangeRecords().getChangeRecord().add(MappingModelToApi.mapChangeRecord(cr));</span>
<span class="fc" id="L1601">                        }</span>

<span class="fc" id="L1603">                        tx.rollback();</span>
<span class="fc" id="L1604">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1605">                        serviceCounter.update(JUDDIQuery.ADMIN_GET_HISTORY,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="fc" id="L1607">                        return res;</span>
<span class="fc" id="L1608">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="fc" id="L1609">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L1610">                        serviceCounter.update(JUDDIQuery.ADMIN_GET_HISTORY,</span>
                                QueryStatus.FAILED, procTime);
<span class="fc" id="L1612">                        throw drfm;</span>

                } finally {
<span class="pc bpc" id="L1615" title="2 of 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="pc" id="L1616">                                tx.rollback();</span>
                        }
<span class="fc" id="L1618">                        em.close();</span>
                }
        }

        /**
         * {@inheritDoc }
         *
         * @param body
         * @return
         * @throws DispositionReportFaultMessage
         * @throws RemoteException
         */
        @Override
        public GetFailedReplicationChangeRecordsMessageResponse getFailedReplicationChangeRecords(
                GetFailedReplicationChangeRecordsMessageRequest body)
                throws DispositionReportFaultMessage, RemoteException {
                //public GetFailedReplicationChangeRecordsMessageResponse getFailedReplicationChangeRecords(GetFailedReplicationChangeRecordsMessageRequest body) throws DispositionReportFaultMessage, RemoteException {
<span class="nc" id="L1635">                long startTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">                if (body == null) {</span>
<span class="nc" id="L1637">                        throw new InvalidValueException(new ErrorMessage(&quot;errors.NullInput&quot;));</span>
                }
<span class="nc" id="L1639">                EntityManager em = PersistenceManager.getEntityManager();</span>
<span class="nc" id="L1640">                EntityTransaction tx = em.getTransaction();</span>
                try {
<span class="nc" id="L1642">                        tx.begin();</span>
<span class="nc" id="L1643">                        UddiEntityPublisher requestor = this.getEntityPublisher(em, body.getAuthInfo());</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">                        if (!((Publisher) requestor).isAdmin()) {</span>
<span class="nc" id="L1645">                                throw new UserMismatchException(new ErrorMessage(&quot;errors.AdminReqd&quot;));</span>
                        }
<span class="nc bnc" id="L1647" title="All 2 branches missed.">                        if (body.getMaxRecords() &lt;= 0) {</span>
<span class="nc" id="L1648">                                body.setMaxRecords(20);</span>
                        }
<span class="nc bnc" id="L1650" title="All 2 branches missed.">                        if (body.getOffset() &lt; 0) {</span>
<span class="nc" id="L1651">                                body.setOffset(0);</span>
                        }
<span class="nc" id="L1653">                        Query createQuery = em.createQuery(&quot;select m from ChangeRecord m where m.isAppliedLocally=false order by m.id DESC &quot;);</span>
<span class="nc" id="L1654">                        createQuery.setMaxResults((int) body.getMaxRecords());</span>
<span class="nc" id="L1655">                        createQuery.setFirstResult((int) body.getOffset());</span>
<span class="nc" id="L1656">                        List&lt;ChangeRecord&gt; resultList = createQuery.getResultList();</span>
<span class="nc" id="L1657">                        GetFailedReplicationChangeRecordsMessageResponse res = new GetFailedReplicationChangeRecordsMessageResponse();</span>
<span class="nc" id="L1658">                        res.setChangeRecords(new ChangeRecords());</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">                        for (ChangeRecord cr : resultList) {</span>
<span class="nc" id="L1660">                                res.getChangeRecords().getChangeRecord().add(MappingModelToApi.mapChangeRecord(cr));</span>
<span class="nc" id="L1661">                        }</span>

<span class="nc" id="L1663">                        tx.rollback();</span>
<span class="nc" id="L1664">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1665">                        serviceCounter.update(JUDDIQuery.ADMIN_GET_FAILED_CRS,</span>
                                QueryStatus.SUCCESS, procTime);
<span class="nc" id="L1667">                        return res;</span>
<span class="nc" id="L1668">                } catch (DispositionReportFaultMessage drfm) {</span>
<span class="nc" id="L1669">                        long procTime = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L1670">                        serviceCounter.update(JUDDIQuery.ADMIN_GET_FAILED_CRS,</span>
                                QueryStatus.FAILED, procTime);
<span class="nc" id="L1672">                        throw drfm;</span>

                } finally {
<span class="nc bnc" id="L1675" title="All 4 branches missed.">                        if (tx.isActive()) {</span>
<span class="nc" id="L1676">                                tx.rollback();</span>
                        }
<span class="nc" id="L1678">                        em.close();</span>
                }
        }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>