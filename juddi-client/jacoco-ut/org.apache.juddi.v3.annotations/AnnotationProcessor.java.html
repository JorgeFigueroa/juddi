<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnnotationProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jUDDI Client side Code</a> &gt; <a href="index.source.html" class="el_package">org.apache.juddi.v3.annotations</a> &gt; <span class="el_source">AnnotationProcessor.java</span></div><h1>AnnotationProcessor.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001-2010 The Apache Software Foundation.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
package org.apache.juddi.v3.annotations;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Properties;

import javax.jws.WebService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.juddi.api_v3.AccessPointType;
import org.apache.juddi.v3.client.ClassUtil;
import org.apache.juddi.v3.client.config.TokenResolver;
import org.uddi.api_v3.AccessPoint;
import org.uddi.api_v3.BindingTemplate;
import org.uddi.api_v3.BindingTemplates;
import org.uddi.api_v3.BusinessService;
import org.uddi.api_v3.CategoryBag;
import org.uddi.api_v3.Description;
import org.uddi.api_v3.KeyedReference;
import org.uddi.api_v3.Name;
import org.uddi.api_v3.TModelInstanceDetails;
import org.uddi.api_v3.TModelInstanceInfo;

<span class="fc" id="L41">public class AnnotationProcessor {</span>
	
	private static final String KEYED_REFERENCE=&quot;keyedReference=&quot;;
	private static final String KEY_NAME=&quot;keyName=&quot;;
	private static final String KEY_VALUE=&quot;keyValue=&quot;;
	private static final String TMODEL_KEY=&quot;tModelKey=&quot;;
	
<span class="fc" id="L48">	private Log log = LogFactory.getLog(AnnotationProcessor.class);</span>
	
	public Collection&lt;BusinessService&gt; readServiceAnnotations(String[] classesWithAnnotations, Properties properties) {
<span class="nc" id="L51">		Collection&lt;BusinessService&gt; services = new ArrayList&lt;BusinessService&gt;();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		for (String className : classesWithAnnotations) {</span>
			try {		
<span class="nc" id="L54">				BusinessService service = readServiceAnnotations(className, properties);</span>
<span class="nc" id="L55">				services.add(service);</span>
<span class="nc" id="L56">			} catch (Exception e) {</span>
<span class="nc" id="L57">				e.printStackTrace();</span>
<span class="nc" id="L58">			}</span>
		}
<span class="nc" id="L60">		return services;</span>
	}
	
	public BusinessService readServiceAnnotations(String classWithAnnotations, Properties properties) throws ClassNotFoundException {
		
<span class="fc" id="L65">		BusinessService service = new BusinessService();</span>
<span class="fc" id="L66">		Class&lt;?&gt; clazz = ClassUtil.forName(classWithAnnotations, this.getClass());</span>
<span class="fc" id="L67">		UDDIService uddiService= (UDDIService) clazz.getAnnotation(UDDIService.class);</span>
<span class="fc" id="L68">		WebService webServiceAnnotation = (WebService) clazz.getAnnotation(WebService.class);</span>
		
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">		if (uddiService!=null) {</span>
			//service
<span class="fc" id="L72">			String lang = &quot;en&quot;; //default to english</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">			if (uddiService.lang()!=null) {</span>
<span class="fc" id="L74">				lang = uddiService.lang();</span>
			}
<span class="fc" id="L76">			Name name = new Name();</span>
<span class="fc" id="L77">			name.setLang(lang); </span>
<span class="fc" id="L78">			service.setBusinessKey(TokenResolver.replaceTokens(uddiService.businessKey(),properties));</span>
<span class="fc" id="L79">			service.setServiceKey(TokenResolver.replaceTokens(uddiService.serviceKey(),properties));</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">			if (!&quot;&quot;.equals(uddiService.serviceName())) {</span>
<span class="nc" id="L81">				name.setValue(TokenResolver.replaceTokens(uddiService.serviceName(),properties));</span>
<span class="pc bpc" id="L82" title="1 of 4 branches missed.">			} else if (webServiceAnnotation!=null &amp;&amp; !&quot;&quot;.equals(webServiceAnnotation.serviceName())) {</span>
<span class="fc" id="L83">				name.setValue(webServiceAnnotation.serviceName());</span>
			} else {
<span class="fc" id="L85">				name.setValue(clazz.getSimpleName());</span>
			}
<span class="fc" id="L87">			service.getName().add(name);</span>
<span class="fc" id="L88">			Description description = new Description();</span>
<span class="fc" id="L89">			description.setLang(lang);</span>
<span class="fc" id="L90">			description.setValue(TokenResolver.replaceTokens(uddiService.description(),properties));</span>
<span class="fc" id="L91">			service.getDescription().add(description);</span>
			
			//categoryBag on the service
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">			if (!&quot;&quot;.equals(uddiService.categoryBag())) {</span>
<span class="nc" id="L95">				CategoryBag categoryBag = parseCategoryBag(uddiService.categoryBag());</span>
<span class="nc" id="L96">		        service.setCategoryBag(categoryBag);</span>
			}
			
			//bindingTemplate on service
<span class="fc" id="L100">			BindingTemplate bindingTemplate = parseServiceBinding(clazz, lang, webServiceAnnotation, properties);</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">			if (bindingTemplate!=null) {</span>
<span class="fc" id="L102">				bindingTemplate.setServiceKey(service.getServiceKey());</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">				if (service.getBindingTemplates()==null) {</span>
<span class="fc" id="L104">					service.setBindingTemplates(new BindingTemplates());</span>
				}
<span class="fc" id="L106">				service.getBindingTemplates().getBindingTemplate().add(bindingTemplate);</span>
			}
			
			
<span class="fc" id="L110">		} else {</span>
<span class="nc" id="L111">			log.error(&quot;Missing UDDIService annotation in class &quot; + classWithAnnotations);</span>
		}
			
<span class="fc" id="L114">		return service;</span>
	}
	
	protected BindingTemplate parseServiceBinding(Class&lt;?&gt; classWithAnnotations, String lang, 
			WebService webServiceAnnotation, Properties properties) {
		
<span class="fc" id="L120">		BindingTemplate bindingTemplate = null;</span>
<span class="fc" id="L121">		UDDIServiceBinding uddiServiceBinding= (UDDIServiceBinding) classWithAnnotations.getAnnotation(UDDIServiceBinding.class);</span>
		//binding
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">		if (uddiServiceBinding!=null) {</span>
<span class="fc" id="L124">			bindingTemplate = new BindingTemplate();</span>
			
<span class="fc" id="L126">			bindingTemplate.setBindingKey(TokenResolver.replaceTokens(uddiServiceBinding.bindingKey(), properties));</span>
			
<span class="fc" id="L128">			String bindingLang = String.valueOf(lang);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">			if (uddiServiceBinding.lang()!=null) {</span>
<span class="fc" id="L130">				bindingLang = TokenResolver.replaceTokens(uddiServiceBinding.lang(),properties);</span>
			}
<span class="fc" id="L132">			Description bindingDescription = new Description();</span>
<span class="fc" id="L133">			bindingDescription.setLang(bindingLang);</span>
<span class="fc" id="L134">			bindingDescription.setValue(TokenResolver.replaceTokens(uddiServiceBinding.description(),properties));</span>
<span class="fc" id="L135">			bindingTemplate.getDescription().add(bindingDescription);</span>
			
<span class="fc" id="L137">			AccessPoint accessPoint = new AccessPoint();</span>
<span class="fc" id="L138">			accessPoint.setUseType(AccessPointType.WSDL_DEPLOYMENT.toString());</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">			if (!&quot;&quot;.equals(uddiServiceBinding.accessPointType())) {</span>
<span class="fc" id="L140">				accessPoint.setUseType(uddiServiceBinding.accessPointType());</span>
			}
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">			if (!&quot;&quot;.equals(uddiServiceBinding.accessPoint())) {</span>
<span class="fc" id="L143">				String endPoint = uddiServiceBinding.accessPoint();</span>
<span class="fc" id="L144">				endPoint = TokenResolver.replaceTokens(endPoint, properties);</span>
<span class="fc" id="L145">                log.debug(&quot;AccessPoint EndPoint=&quot; + endPoint);</span>
<span class="fc" id="L146">				accessPoint.setValue(endPoint);</span>
<span class="pc bnc" id="L147" title="All 4 branches missed.">			} else if (webServiceAnnotation!=null &amp;&amp; webServiceAnnotation.wsdlLocation()!=null) {</span>
<span class="nc" id="L148">				accessPoint.setValue(webServiceAnnotation.wsdlLocation());</span>
			}
<span class="fc" id="L150">			bindingTemplate.setAccessPoint(accessPoint);</span>
			
			//tModelKeys on the binding
<span class="fc bfc" id="L153" title="All 2 branches covered.">			if (!&quot;&quot;.equals(uddiServiceBinding.tModelKeys())) {</span>
<span class="fc" id="L154">				String[] tModelKeys= uddiServiceBinding.tModelKeys().split(&quot;,&quot;);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">				for (String tModelKey : tModelKeys) {</span>
<span class="fc" id="L156">					TModelInstanceInfo instanceInfo = new TModelInstanceInfo();</span>
<span class="fc" id="L157">					instanceInfo.setTModelKey(tModelKey);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">					if (bindingTemplate.getTModelInstanceDetails()==null) {</span>
<span class="fc" id="L159">						bindingTemplate.setTModelInstanceDetails(new TModelInstanceDetails());</span>
					}
<span class="fc" id="L161">					bindingTemplate.getTModelInstanceDetails().getTModelInstanceInfo().add(instanceInfo);</span>
				}
			}
			//categoryBag on the binding
<span class="fc bfc" id="L165" title="All 2 branches covered.">			if (!&quot;&quot;.equals(uddiServiceBinding.categoryBag())) {</span>
<span class="fc" id="L166">				CategoryBag categoryBag = parseCategoryBag(uddiServiceBinding.categoryBag());</span>
<span class="fc" id="L167">		        bindingTemplate.setCategoryBag(categoryBag);</span>
			}
<span class="fc" id="L169">		} else {</span>
<span class="nc" id="L170">			log.error(&quot;Missing UDDIServiceBinding annotation in class &quot; + classWithAnnotations);</span>
		}
<span class="fc" id="L172">		return bindingTemplate;</span>
	}
	/**
	 * parse something like: [keyName=uddi-org:types:wsdl,keyValue=wsdlDeployment,tModelKey=uddi:uddi.org:categorization:types]
							
	 * @param categoryBagStr
	 * @return a UDDI CategoryBag
         * @see CategoryBag
	 */
	protected CategoryBag parseCategoryBag(String categoryBagStr) {
		
<span class="fc" id="L183">		CategoryBag categoryBag = new CategoryBag();</span>
<span class="fc" id="L184">		log.debug(&quot;CategoryBag Annotation=&quot; + categoryBagStr);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">		if (!&quot;&quot;.equals(categoryBagStr)) {</span>
<span class="fc" id="L186">			String[] sections = categoryBagStr.split(&quot;,&quot;);</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">	        for (String section : sections) {</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">	        	if (section.startsWith(KEYED_REFERENCE)) {</span>
<span class="fc" id="L189">		            String keyedReferenceStr = section.substring(KEYED_REFERENCE.length(),section.length());</span>
<span class="fc" id="L190">		            log.debug(&quot;Found KeyedReference=&quot; + keyedReferenceStr);</span>
<span class="fc" id="L191">		            String[] keyedReferences = keyedReferenceStr.split(&quot;;&quot;);</span>
<span class="fc" id="L192">		            KeyedReference keyedReference = new KeyedReference();</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">		            for (String key : keyedReferences) {</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">						if (key.startsWith(KEY_NAME)) keyedReference.setKeyName(key.substring(KEY_NAME.length(),key.length()));</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">						if (key.startsWith(KEY_VALUE)) keyedReference.setKeyValue(key.substring(KEY_VALUE.length(),key.length()));</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">						if (key.startsWith(TMODEL_KEY)) keyedReference.setTModelKey(key.substring(TMODEL_KEY.length(),key.length()));</span>
					}
<span class="fc" id="L198">		            log.debug(&quot;KeyedReference = &quot; + KEY_NAME + keyedReference.getKeyName() + &quot; &quot; </span>
<span class="fc" id="L199">		            		                      + KEY_VALUE + keyedReference.getKeyValue() + &quot; &quot;</span>
<span class="fc" id="L200">		            		                      + TMODEL_KEY + keyedReference.getTModelKey());</span>
<span class="fc" id="L201">		            categoryBag.getKeyedReference().add(keyedReference);</span>
<span class="fc" id="L202">	        	} else {</span>
<span class="nc" id="L203">	        		log.warn(&quot;Ignoring &quot; + section);</span>
	                 //TODO add support for KeyedReferenceGroups?
	        	}
	        }
        }
<span class="fc" id="L208">        return categoryBag;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>